From 05a53b59016ebedbf46c191d5138f8c30de662c0 Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Fri, 2 Apr 2021 20:55:00 +0800
Subject: [PATCH 116/122] uu_accel: add switch for UU accelerator.

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 release/src/router/rc/init.c             |  3 +
 release/src/router/rc/k3.c               | 64 ++++++++++++------
 release/src/router/rc/k3.h               |  3 +
 release/src/router/rc/services.c         |  8 +++
 release/src/router/shared/defaults.c     |  3 +
 release/src/router/www/UUAccelerator.asp | 82 ++++++++++++++++++++----
 6 files changed, 132 insertions(+), 31 deletions(-)

diff --git a/release/src/router/rc/init.c b/release/src/router/rc/init.c
index bfb1cfaa69..cadc2b08b0 100644
--- a/release/src/router/rc/init.c
+++ b/release/src/router/rc/init.c
@@ -11462,6 +11462,9 @@ int init_nvram(void)
 #else
 		add_rc_support("mssid 2.4G 5G usbX2");
 #endif
+#ifdef RTCONFIG_UUPLUGIN
+		add_rc_support("uu_accel");
+#endif
 #ifdef RTCONFIG_TCPLUGIN
 		add_rc_support("tencent_qmacc");
 #endif
diff --git a/release/src/router/rc/k3.c b/release/src/router/rc/k3.c
index 41f03ce6e7..954f5a9999 100644
--- a/release/src/router/rc/k3.c
+++ b/release/src/router/rc/k3.c
@@ -166,6 +166,7 @@ void k3_init(void)
 		nvram_set("location_code", "AU");
 		isChange = 1;
 	}
+	nvram_set("netease_uu_md5", "");
 
 	if (isChange)
 	{
@@ -288,14 +289,18 @@ int GetPhyStatus(int verbose, phy_info_list *list)
 #ifdef RTCONFIG_UUPLUGIN
 void exec_uu_k3(void)
 {
-	FILE *fpmodel, *fpmac, *fpuu, *fpurl, *fpmd5, *fpcfg;
+	FILE *fpmodel, *fpmac, *fpdir, *fpurl, *fpmd5, *fpcfg;
 	char buf[128];
-	int download, i;
 	char *dup, *url, *md5;
+	int result;
 
-	if(nvram_get_int("sw_mode") == 1)
+	if (!nvram_match("netease_uu_enable", "1"))
+	{
+		system("killall uuplugin_monitor.sh");
+		system("killall uuplugin");
+	}
+	else if (nvram_get_int("ntp_ready") && nvram_get_int("sw_mode") == 1)
 	{
-		add_rc_support("uu_accel");
 		if ((fpmodel = fopen("/var/model", "w")))
 		{
 			fprintf(fpmodel, nvram_get("productid"));
@@ -308,17 +313,19 @@ void exec_uu_k3(void)
 			fprintf(fpmac, etmac);
 			fclose(fpmac);
 		}
-		if ((fpuu = fopen("/var/uu_plugin_dir", "w")))
+		if ((fpdir = fopen("/var/uu_plugin_dir", "w")))
 		{
-			fprintf(fpuu, "/jffs");
-			fclose(fpuu);
+			fprintf(fpdir, "/jffs");
+			fclose(fpdir);
 		}
-		system("mkdir -p /tmp/uu");
-		download = system("wget -t 2 -T 30 --dns-timeout=120 --header=Accept:text/plain -q --no-check-certificate 'https://router.uu.163.com/api/script/monitor?type=asuswrt-merlin' -O /tmp/uu/script_url");
-		if (!download)
+		mkdir_if_none("/tmp/uu");
+		result = system("wget -t 2 -T 30 --dns-timeout=120 --header=Accept:text/plain \
+			-q --no-check-certificate 'https://router.uu.163.com/api/script/monitor?type=asuswrt-merlin' \
+			-O /tmp/uu/script_url");
+		if (!result)
 		{
 			kprintf("download uuplugin script info successfully\n");
-			if (fpurl = fopen("/tmp/uu/script_url", "r"))
+			if ((fpurl = fopen("/tmp/uu/script_url", "r")))
 			{
 				fgets(buf, 128, fpurl);
 				fclose(fpurl);
@@ -328,18 +335,35 @@ void exec_uu_k3(void)
 				md5 = strsep(&dup, ",");
 				if (md5 != NULL)
 				{
-					kprintf("URL: %s\n", url);
-					kprintf("MD5: %s\n", md5);
-					if (!doSystem("wget -t 2 -T 30 --dns-timeout=120 --header=Accept:text/plain -q --no-check-certificate %s -O /tmp/uu/uuplugin_monitor.sh", url))
+					if (nvram_match("netease_uu_md5", md5))
+					{
+						kprintf("MD5: %s is the same. skip download.\n", md5);
+						if (pids("uuplugin"))
+							result = 1;
+						else
+							result = 0;
+					}
+					else
+					{
+						kprintf("URL: %s\n", url);
+						kprintf("MD5: %s\n", md5);
+						mkdir_if_none("/jffs/uu");
+						result = doSystem("wget -t 2 -T 30 --dns-timeout=120 --header=Accept:text/plain \
+							-q --no-check-certificate %s -O /jffs/uu/uuplugin_monitor.sh", url);
+					}
+
+					if (!result)
 					{
 						kprintf("download uuplugin script successfully\n");
-						if ((fpcfg = fopen("/tmp/uu/uuplugin_monitor.config", "w")))
+						nvram_set("netease_uu_md5", md5);
+						if ((fpcfg = fopen("/jffs/uu/uuplugin_monitor.config", "w")))
 						{
 							fprintf(fpcfg, "router=asuswrt-merlin\n");
-							fprintf(fpcfg, "model=RT-AC3100\n");
+							fprintf(fpcfg, "model=\n");
 							fclose(fpcfg);
 						}
-						if ((fpmd5=popen("md5sum /tmp/uu/uuplugin_monitor.sh | awk '{print $1}'", "r")))
+
+						if ((fpmd5=popen("md5sum /jffs/uu/uuplugin_monitor.sh | awk '{print $1}'", "r")))
 						{
 							bzero(buf, sizeof(buf));
 							if((fread(buf, 1, 128, fpmd5)))
@@ -347,9 +371,11 @@ void exec_uu_k3(void)
 								if (!strncasecmp(buf, md5, 32))
 								{
 									pid_t pid;
-									char *uu_argv[] = { "/tmp/uu/uuplugin_monitor.sh", NULL };
+									char *uu_argv[] = { "/jffs/uu/uuplugin_monitor.sh", NULL };
 									kprintf("prepare to execute uuplugin stript...\n");
-									chmod("/tmp/uu/uuplugin_monitor.sh", 0755);
+									system("killall uuplugin_monitor.sh");
+									system("killall uuplugin");
+									chmod("/jffs/uu/uuplugin_monitor.sh", 0755);
 									_eval(uu_argv, NULL, 0, &pid);
 								}
 							}
diff --git a/release/src/router/rc/k3.h b/release/src/router/rc/k3.h
index fc4f93cea7..51dcb8f39b 100644
--- a/release/src/router/rc/k3.h
+++ b/release/src/router/rc/k3.h
@@ -22,3 +22,6 @@ extern void update_cfe_k3(void);
 extern void k3_init(void);
 extern void k3_init_done(void);
 extern void start_k3screen(void);
+#ifdef RTCONFIG_UUPLUGIN
+void exec_uu_k3(void);
+#endif
diff --git a/release/src/router/rc/services.c b/release/src/router/rc/services.c
index 4b33fd4919..8126eae656 100644
--- a/release/src/router/rc/services.c
+++ b/release/src/router/rc/services.c
@@ -14350,6 +14350,14 @@ check_ddr_done:
 			eval("iptables", "-t", "mangle", "-D", "BWDPI_FILTER", "-i", dev_wan, "-p", "udp", "--sport", "67", "--dport", "68", "-j", "DROP");
 		}
 	}
+#if defined(RTCONFIG_UUPLUGIN)
+	else if (strcmp(script, "uu_check") == 0)
+	{
+		if(action & RC_SERVICE_START){
+			exec_uu_k3();
+		}
+	}
+#endif
 	else if (strcmp(script, "dpi_disable") == 0)
 	{
 		disable_dpi_engine_setting();
diff --git a/release/src/router/shared/defaults.c b/release/src/router/shared/defaults.c
index cd12752cd5..359a8697a3 100644
--- a/release/src/router/shared/defaults.c
+++ b/release/src/router/shared/defaults.c
@@ -3830,6 +3830,9 @@ struct nvram_tuple router_defaults[] = {
 #if defined(RTAC86U) || defined(GTAC2900)
 	{ "cpuwait", "1", CKN_STR1, CKN_TYPE_DEFAULT, CKN_ACC_LEVEL_DEFAULT, CKN_ENC_DEFAULT, 0 },
 #endif
+#ifdef RTCONFIG_UUPLUGIN
+	{ "netease_uu_enable", "0", CKN_STR1, CKN_TYPE_DEFAULT, CKN_ACC_LEVEL_DEFAULT, CKN_ENC_DEFAULT, 0 },
+#endif
 #ifdef RTCONFIG_TCPLUGIN
 	{ "tencent_qmacc_enable"    , "0", CKN_STR1  , CKN_TYPE_DEFAULT, CKN_ACC_LEVEL_DEFAULT, CKN_ENC_DEFAULT, 0 },
 	{ "tencent_eula_check"      , "0", CKN_STR1  , CKN_TYPE_DEFAULT, CKN_ACC_LEVEL_DEFAULT, CKN_ENC_DEFAULT, 0 },
diff --git a/release/src/router/www/UUAccelerator.asp b/release/src/router/www/UUAccelerator.asp
index 3e8d0677f6..a78ea2d1ab 100644
--- a/release/src/router/www/UUAccelerator.asp
+++ b/release/src/router/www/UUAccelerator.asp
@@ -13,18 +13,42 @@
 <link rel="stylesheet" type="text/css" href="usp_style.css">
 <link rel="stylesheet" type="text/css" href="app_installation.css">
 <script type="text/javascript" src="/state.js"></script>
+<script type="text/javascript" src="/general.js"></script>
 <script type="text/javascript" src="/popup.js"></script>
 <script type="text/javascript" src="/help.js"></script>
+<script type="text/javascript" src="/validator.js"></script>
 <script type="text/javascript" src="/js/jquery.js"></script>
+<script type="text/javascript" src="/switcherplugin/jquery.iphone-switch.js"></script>
 <script>
 	var label_mac = <% get_label_mac(); %>;
 function initial(){
 	show_menu();
-
+	uu_check_status();
 }
 function uuRegister(mac){
 	var _mac = mac.toLowerCase();
-	window.open('https://router.uu.163.com/asus/pc.html#/acce?gwSn=' + _mac + '&type=asuswrt', '_blank');
+	window.open('https://router.uu.163.com/asus/pc.html#/acce?gwSn=' + _mac + '&type=asuswrt-merlin', '_blank');
+}
+function uu_version_check(){
+	document.getElementById("btn_check").disabled = true;
+	document.uu_update.submit();
+	document.getElementById("uu_status").innerHTML = "MD5: 检查中...";
+	document.getElementById("uu_update_scan").style.display = "";
+	setTimeout("uu_check_status();", 3000);
+}
+function uu_check_status(){
+	﻿md5 = '<% nvram_get("netease_uu_md5"); %>';
+	uu_enabled = '<% nvram_get("netease_uu_enable"); %>';
+	document.getElementById("uu_status").innerHTML = "MD5: "+md5;
+	if(uu_enabled == 1)
+		document.getElementById("btn_check").disabled = false;
+	else
+		document.getElementById("btn_check").disabled = true;
+	document.getElementById("uu_update_scan").style.display = "none";
+}
+function applyRule() {
+	showLoading();
+	document.form.submit();
 }
 </script>
 </head>
@@ -36,20 +60,30 @@ function uuRegister(mac){
 <form method="post" name="form" action="/start_apply.htm" target="hidden_frame">
 <input type="hidden" name="preferred_lang" id="preferred_lang" value="<% nvram_get("preferred_lang"); %>">
 <input type="hidden" name="firmver" value="<% nvram_get("firmver"); %>">
-<input type="hidden" name="action_mode" value="">
-<input type="hidden" name="action_script" value="">
+<input type="hidden" name="current_page" value="UUAccelerator.asp">
+<input type="hidden" name="next_page" value="">
+<input type="hidden" name="group_id" value="">
+<input type="hidden" name="action_mode" value="apply">
+<input type="hidden" name="action_script" value="start_uu_check">
+<input type="hidden" name="action_wait" value="2">
+<input type="hidden" name="netease_uu_enable" value="<% nvram_get("netease_uu_enable"); %>">
+</form>
+<form method="post" name="uu_update" action="/start_apply.htm" target="hidden_frame">
+<input type="hidden" name="productid" value="<% nvram_get("productid"); %>">
+<input type="hidden" name="action_mode" value="apply">
+<input type="hidden" name="action_script" value="start_uu_check">
 <input type="hidden" name="action_wait" value="">
 </form>
 
 <div>
 	<table class="content" align="center" cellspacing="0" style="margin:auto;">
 		<tr>
-			<td width="17">&nbsp;</td>	
+			<td width="17">&nbsp;</td>
 			<!--=====Beginning of Main Menu=====-->
 			<td valign="top" width="202">
 				<div id="mainMenu"></div>
 				<div id="subMenu"></div>
-			</td>	
+			</td>
 			<td valign="top">
 				<div id="tabMenu" class="submenuBlock"></div>
 				<br>
@@ -64,14 +98,31 @@ function uuRegister(mac){
 											<td align="left">
 												<span class="formfonttitle"><#UU_Accelerator#></span>
 											</td>
+											<td align="right">
+												<div align="center" class="left" style="width:94px; float:right; cursor:pointer;" id="uu_enable"></div>
+												<script type="text/javascript">
+													$('#uu_enable').iphoneSwitch('<% nvram_get("netease_uu_enable"); %>',
+														function(){
+															document.form.netease_uu_enable.value = 1;
+															document.getElementById("btn_check").disabled = false;
+															applyRule();
+														},
+														function(){
+															document.form.netease_uu_enable.value = 0;
+															document.getElementById("btn_check").disabled = true;
+															applyRule();
+														}
+													);
+												</script>
+											</td>
 										</tr>
 									</table>
 								</div>
 							</td>
-						</tr> 
+						</tr>
 						<tr>
 							<td><div class="splitLine"></div></td>
-						</tr> 
+						</tr>
 					</table>
 					<div style="display:flex;border: 2px solid #41484a;padding: 18px 6px;align-items: center;border-radius:4px;margin: 12px 6px;">
 						<div style="margin: 0 12px;">
@@ -83,15 +134,22 @@ function uuRegister(mac){
 								<div style="font-size: 16px;"><#UU_Accelerator#></div>
 								<div style="margin-right:12px;"><a href="https://uu.163.com/router/" target="_blank">FAQ</a></div>
 							</div>
-							<div style="color: #FC0;"><#UU_Accelerator_desc#></div>
+							<div style="color: #FC0;margin-bottom:12px;"><#UU_Accelerator_desc#></div>
+							<div>
+								<span id="uu_status" style="color: #FC0;"></span>
+								<img id="uu_update_scan" style="display:none;" src="images/InternetScan.gif">
+							</div>
 						</div>
 						<div style="width:1px;height: 120px;background-color: #929EA1"></div>
-						<div style="margin: auto;" onclick="uuRegister(label_mac);">
-							<input type="button" class="button_gen" value="<#btn_go#>">
+						<div style="width:122px;margin: auto;">
+							<input type="button" class="button_gen" onclick="uuRegister(label_mac);" value="<#btn_go#>">
+							<div style="margin-top: 12px;">
+								<input type="button" id="btn_check" name="btn_check" class="button_gen" onclick="uu_version_check();" value="<#liveupdate#>">
+							</div>
 						</div>
 					</div>
 				</div>
-				
+
 		<!--=====End of Main Content=====-->
 			</td>
 			<td width="20" align="center" valign="top"></td>
-- 
2.25.1

