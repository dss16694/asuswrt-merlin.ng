From b69fe34de8ee7eab713d1efba102773eaed63625 Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Tue, 5 May 2020 14:39:00 +0800
Subject: [PATCH 020/122] k3init: fix upgrade kernel panic cause by
 nvram_commit.

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 release/src/router/rc/k3.c | 16 +++++++++++++---
 1 file changed, 13 insertions(+), 3 deletions(-)

diff --git a/release/src/router/rc/k3.c b/release/src/router/rc/k3.c
index faf8077d6a..22f610d2c2 100644
--- a/release/src/router/rc/k3.c
+++ b/release/src/router/rc/k3.c
@@ -28,11 +28,21 @@
 
 void k3_init()
 {
-	if (!nvram_get("modelname"))
+	bool isChange = 0;
+
+	if (!nvram_safe_get("modelname"))
+	{
 		nvram_set("modelname", "K3");
-	if (!nvram_get("screen_timeout"))
+		isChange = 1;
+	}
+	if (!nvram_safe_get("screen_timeout"))
+	{
 		nvram_set("screen_timeout", "30");
-	nvram_commit();
+		isChange = 1;
+	}
+
+	if (isChange)
+		nvram_commit();
 }
 
 void k3_init_done()
-- 
2.25.1

