From 83576849500a84d6837746d510366afd92a1b7ee Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Sun, 9 Aug 2020 18:32:32 +0800
Subject: [PATCH 077/122] rc: fix crash of dnsmasq due to enable a certain
 plugin in softcenter.

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 release/src/router/rc/services.c | 21 +++++++++++++++++++++
 1 file changed, 21 insertions(+)

diff --git a/release/src/router/rc/services.c b/release/src/router/rc/services.c
index 6a21da0126..4b33fd4919 100644
--- a/release/src/router/rc/services.c
+++ b/release/src/router/rc/services.c
@@ -1847,10 +1847,16 @@ void start_dnsmasq(void)
 		   "dhcp-ignore-names=tag:wpad-ignore\n");
 
 	/* dhcp-script */
+#if defined(RTCONFIG_SOFTCENTER)
+	if (!f_exists("/jffs/configs/dnsmasq.d/dhcp_trigger.conf"))
+#endif
 	fprintf(fp, "dhcp-script=/sbin/dhcpc_lease\n");
 #if defined(RTCONFIG_AMAS)
 	fprintf(fp, "script-arp\n");
 #endif
+#define dir_dnsmasq "/jffs/configs/dnsmasq.d"
+	if (d_exists(dir_dnsmasq))
+		fprintf(fp, "conf-dir=%s\n", dir_dnsmasq);
 
 	/* close fp move to the last */
 	append_custom_config("dnsmasq.conf",fp);
@@ -1865,6 +1871,21 @@ void start_dnsmasq(void)
 	/* Create resolv.dnsmasq with empty server list */
 	f_write(dmservers, NULL, 0, FW_APPEND, 0644);
 
+#if defined(RTCONFIG_SOFTCENTER) && defined(RTCONFIG_AMAS)
+	fp = fopen("/jffs/configs/dnsmasq.d/dhcp_trigger.conf", "r");
+	if (fp) {
+		char buffer[128], file[128];
+		while (fgets(buffer, sizeof(buffer), fp)) {
+			if (sscanf(buffer, "dhcp-script=%115s", file) == 1) {
+				eval("sed", "-i", "/dhcpc_lease/d", file);
+				eval("sed", "-i", "2i\\/sbin/dhcpc_lease $@", file);
+				break;
+			}
+		}
+		fclose(fp);
+	}
+#endif
+
 #ifdef RTCONFIG_DNSPRIVACY
 	start_stubby();
 #endif
-- 
2.25.1

