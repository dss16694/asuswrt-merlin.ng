From 0fb73ceccc653b58f41e9f6d22cafed63e1ef599 Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Mon, 13 Apr 2020 00:49:50 +0800
Subject: [PATCH 004/122] =?UTF-8?q?nand=20flash=E6=96=87=E4=BB=B6=E7=B3=BB?=
 =?UTF-8?q?=E7=BB=9F=E4=BB=8EJFFS2=E6=94=B9=E4=B8=BAUBIFS,=E7=A6=81?=
 =?UTF-8?q?=E7=94=A8NAND=E9=A9=B1=E5=8A=A8=E5=AD=90=E9=A1=B5(=E4=B8=8D?=
 =?UTF-8?q?=E6=94=AF=E6=8C=81)=20Change=20JFFS2=20to=20UBIFS=20file=20syst?=
 =?UTF-8?q?em=EF=BC=8Cdisable=20SUBPAGE=5FWRITE?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 .../src/linux/linux-2.6.36/config_base.6a     | 16 +++++++++-
 .../linux-2.6.36/drivers/mtd/nand/nand_base.c |  4 +++
 release/src-rt/target.mak                     |  3 +-
 release/src/router/mtd-utils/Makefile         |  7 ++--
 release/src/router/rc/ubifs.c                 | 32 +++++++++++++++----
 5 files changed, 51 insertions(+), 11 deletions(-)

diff --git a/release/src-rt-7.14.114.x/src/linux/linux-2.6.36/config_base.6a b/release/src-rt-7.14.114.x/src/linux/linux-2.6.36/config_base.6a
index 1a07a1da72..b6c3a5ca58 100644
--- a/release/src-rt-7.14.114.x/src/linux/linux-2.6.36/config_base.6a
+++ b/release/src-rt-7.14.114.x/src/linux/linux-2.6.36/config_base.6a
@@ -921,7 +921,15 @@ CONFIG_MTD_NAND_IDS=y
 #
 # UBI - Unsorted block images
 #
-# CONFIG_MTD_UBI is not set
+CONFIG_MTD_UBI=y
+CONFIG_MTD_UBI_WL_THRESHOLD=4096
+CONFIG_MTD_UBI_BEB_RESERVE=1
+# CONFIG_MTD_UBI_GLUEBI is not set
+
+#
+# UBI debugging options
+#
+# CONFIG_MTD_UBI_DEBUG is not set
 
 #
 # Broadcom Flash Devices Support
@@ -1664,6 +1672,12 @@ CONFIG_JFFS2_RTIME=y
 CONFIG_JFFS2_CMODE_PRIORITY=y
 # CONFIG_JFFS2_CMODE_SIZE is not set
 # CONFIG_JFFS2_CMODE_FAVOURLZO is not set
+CONFIG_UBIFS_FS=y
+CONFIG_UBIFS_FS_XATTR=y
+CONFIG_UBIFS_FS_ADVANCED_COMPR=y
+CONFIG_UBIFS_FS_LZO=y
+CONFIG_UBIFS_FS_ZLIB=y
+# CONFIG_UBIFS_FS_DEBUG is not set
 # CONFIG_LOGFS is not set
 # CONFIG_CRAMFS is not set
 CONFIG_SQUASHFS=y
diff --git a/release/src-rt-7.14.114.x/src/linux/linux-2.6.36/drivers/mtd/nand/nand_base.c b/release/src-rt-7.14.114.x/src/linux/linux-2.6.36/drivers/mtd/nand/nand_base.c
index dfd503f3fc..c4a9ea6f0a 100644
--- a/release/src-rt-7.14.114.x/src/linux/linux-2.6.36/drivers/mtd/nand/nand_base.c
+++ b/release/src-rt-7.14.114.x/src/linux/linux-2.6.36/drivers/mtd/nand/nand_base.c
@@ -2950,7 +2950,11 @@ static struct nand_flash_dev *nand_get_flash_type(struct mtd_info *mtd,
 		chip->badblockpos = NAND_SMALL_BADBLOCK_POS;
 
 	/* Get chip options, preserve non chip based options */
+#ifdef RTK3
+	chip->options |= NAND_NO_SUBPAGE_WRITE;
+#else
 	chip->options &= ~NAND_CHIPOPTIONS_MSK;
+#endif
 	chip->options |= type->options & NAND_CHIPOPTIONS_MSK;
 
 	/*
diff --git a/release/src-rt/target.mak b/release/src-rt/target.mak
index 4dd5c095b7..0389b8d5ad 100644
--- a/release/src-rt/target.mak
+++ b/release/src-rt/target.mak
@@ -208,7 +208,8 @@ export RT-AC3100 += BUILD_NAME="RT-AC3100" SWITCH2="" BCM_MMC=n BCM_7114=y ETLAN
 export RT-K3 := $(RT-AC88U_BASE)
 export RT-K3 += BUILD_NAME="RT-K3" SWITCH2="" BCM_MMC=n BCM_7114=y NOWLALL=n ETLAN_LED=n ROMCFE=n \
 		NVSIZE="128" NOWL=y DHDAP=y DPSTA=y BCMFA=n GMAC3=y LACP=y WTFAST=y \
-		FORCE_SN="380" FORCE_EN="664" DISABLE_REPEATER_UI=n NEWSSID_REV2=y
+		FORCE_SN="380" FORCE_EN="664" DISABLE_REPEATER_UI=n NEWSSID_REV2=y \
+		BRCM_NAND_JFFS2=n JFFS2LOG=n UBI=y UBIFS=y PSISTLOG=y
 
 export RT-AC5300 := $(RT-AC88U_BASE)
 export RT-AC5300 += BUILD_NAME="RT-AC5300" RGMII_BRCM5301X=y SWITCH2="" BCM_MMC=n BCM_7114=y ETLAN_LED=y \
diff --git a/release/src/router/mtd-utils/Makefile b/release/src/router/mtd-utils/Makefile
index de6602d54a..551408be48 100644
--- a/release/src/router/mtd-utils/Makefile
+++ b/release/src/router/mtd-utils/Makefile
@@ -38,9 +38,9 @@ SCRIPTS = flash_eraseall
 ifeq ($(ALPINE)$(LANTIQ),y)
 # BINS =
 else
-BINS =
+BINS = flash_erase nanddump nandwrite nandtest
 endif
-SCRIPTS =
+SCRIPTS = flash_eraseall
 
 ifeq ($(UBIFS),y)
 BINS += mkfs.ubifs/mkfs.ubifs
@@ -55,6 +55,9 @@ endif
 ifeq ($(ALPINE)$(LANTIQ),y)
 UBI_BINS += ubiformat ubiattach ubimkvol ubidetach ubiupdatevol ubirmvol
 endif
+ifeq ($(RTK3),y))
+UBI_BINS += ubiformat ubiattach ubimkvol ubidetach ubiupdatevol ubirmvol
+endif
 BINS += $(addprefix ubi-utils/,$(UBI_BINS))
 endif
 
diff --git a/release/src/router/rc/ubifs.c b/release/src/router/rc/ubifs.c
index 62ac03af2a..c1bef6b336 100644
--- a/release/src/router/rc/ubifs.c
+++ b/release/src/router/rc/ubifs.c
@@ -33,6 +33,14 @@
 #define NUM_OH_LEB	24		/* for ubifs overhead */
 #endif
 
+#ifdef RTK3
+#define JFFS2_MTD_NAME	"brcmnand"
+#define UBI_DEV_NUM	0
+#define UBI_DEV_PATH	"/dev/ubi0"
+#define LEBS		0x1F000		/* 124 KiB */
+#define NUM_OH_LEB	24		/* for ubifs overhead */
+#endif
+
 static void error(const char *message)
 {
 	char s[512];
@@ -122,7 +130,7 @@ void start_ubifs(void)
 #if defined(RTCONFIG_TEST_BOARDDATA_FILE)
 	int r;
 #endif
-#ifdef RTCONFIG_MTK_NAND
+#if defined(RTCONFIG_MTK_NAND) || defined(RTK3)
 	int mtd_part = 0, mtd_size = 0;
 	char dev_mtd[] = "/dev/mtdXXX";
 #endif
@@ -140,7 +148,7 @@ void start_ubifs(void)
 		return;
 #endif
 
-#ifdef RTCONFIG_MTK_NAND
+#if defined(RTCONFIG_MTK_NAND) || defined(RTK3)
 	if (!mtd_getinfo(JFFS2_MTD_NAME, &mtd_part, &mtd_size)) return;
 
 	_dprintf("*** ubifs: %s (%d, %d)\n", UBIFS_VOL_NAME, mtd_part, mtd_size);
@@ -149,19 +157,27 @@ void start_ubifs(void)
 		/* attach ubi */
 		snprintf(dev_mtd, sizeof(dev_mtd), "/dev/mtd%d", mtd_part);
 		_dprintf("*** ubifs: attach (%s, %d)\n", dev_mtd, UBI_DEV_NUM);
-		eval("ubiattach", "-p", dev_mtd, "-d", UBI_DEV_NUM);
+		//eval("ubiattach", "-p", dev_mtd, "-d", UBI_DEV_NUM);
+		doSystem("ubiattach -p %s -d %d", dev_mtd, UBI_DEV_NUM);
 	}
 
 	if (ubi_getinfo(UBIFS_VOL_NAME, &dev, &part, &size) == 1) {	//ubi volume not found, format it and create volume
 		unsigned int num_leb = 0, num_avail_leb = 0, vol_size = 0;
-		
+
 		_dprintf("*** ubifs: ubi volume not found\n");
 
+#ifdef RTK3
+		/* format ubi */
+		snprintf(dev_mtd, sizeof(dev_mtd), "/dev/mtd%d", mtd_part);
+		_dprintf("*** ubifs: format (%s)\n", dev_mtd);
+		doSystem("ubiformat -y %s", dev_mtd);
+#else
 		/* mtd erase on UBIFS_VOL_NAME first */
 		if (mtd_erase(JFFS2_MTD_NAME)) {
 			error("formatting");
 			return;
 		}
+#endif
 
 		/* compute jffs2's volume size */
 		num_leb = mtd_size >> 17;			/* compute number of leb divde by 128KiB */
@@ -176,11 +192,13 @@ void start_ubifs(void)
 			/* attach ubi */
 			snprintf(dev_mtd, sizeof(dev_mtd), "/dev/mtd%d", mtd_part);
 			_dprintf("*** ubifs: attach (%s, %d)\n", dev_mtd, UBI_DEV_NUM);
-			eval("ubiattach", "-p", dev_mtd, "-d", UBI_DEV_NUM);
+			//eval("ubiattach", "-p", dev_mtd, "-d", UBI_DEV_NUM);
+			doSystem("ubiattach -p %s -d %d", dev_mtd, UBI_DEV_NUM);
 
 			/* make ubi volume */
 			_dprintf("*** ubifs: create jffs2 volume\n");
-			eval("ubimkvol", UBI_DEV_PATH, "-s", vol_size_s, "-N", UBIFS_VOL_NAME);
+			//eval("ubimkvol", UBI_DEV_PATH, "-s", vol_size_s, "-N", UBIFS_VOL_NAME);
+			doSystem("ubimkvol %s -s %s -N %s", UBI_DEV_PATH, vol_size_s, UBIFS_VOL_NAME);
 		}
 	}
 #endif
@@ -223,7 +241,7 @@ void start_ubifs(void)
 			error("unlocking");
 			return;
 		}
-#ifdef RTCONFIG_MTK_NAND
+#if defined(RTCONFIG_MTK_NAND) || defined(RTK3)
 		nvram_unset("ubifs_clean_fs");
 		nvram_commit_x();
 #endif
-- 
2.25.1

