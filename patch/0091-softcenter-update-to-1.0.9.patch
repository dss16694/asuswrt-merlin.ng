From fef3bec214dd2fe292d6b112947eb96d402a8f53 Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Sun, 24 Jan 2021 21:55:33 +0800
Subject: [PATCH 091/122] softcenter: update to 1.0.9

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 .../router/softcenter/softcenter/.soft_ver    |   2 +-
 .../softcenter/softcenter/res/softcenter.css  |  42 ++
 .../softcenter/scripts/ks_app_install.sh      | 552 +++++++++++-------
 .../softcenter/scripts/ks_tar_install.sh      | 168 ++++--
 .../softcenter/webs/Module_Softcenter.asp     | 504 +++++++++++-----
 .../softcenter/webs/Module_Softsetting.asp    |  19 +-
 6 files changed, 877 insertions(+), 410 deletions(-)
 mode change 100644 => 100755 release/src/router/softcenter/softcenter/.soft_ver
 mode change 100644 => 100755 release/src/router/softcenter/softcenter/res/softcenter.css
 mode change 100644 => 100755 release/src/router/softcenter/softcenter/webs/Module_Softcenter.asp
 mode change 100644 => 100755 release/src/router/softcenter/softcenter/webs/Module_Softsetting.asp

diff --git a/release/src/router/softcenter/softcenter/.soft_ver b/release/src/router/softcenter/softcenter/.soft_ver
old mode 100644
new mode 100755
index ee90284c27..66c4c2263e
--- a/release/src/router/softcenter/softcenter/.soft_ver
+++ b/release/src/router/softcenter/softcenter/.soft_ver
@@ -1 +1 @@
-1.0.4
+1.0.9
diff --git a/release/src/router/softcenter/softcenter/res/softcenter.css b/release/src/router/softcenter/softcenter/res/softcenter.css
old mode 100644
new mode 100755
index e3025dea6d..8285dc7c9a
--- a/release/src/router/softcenter/softcenter/res/softcenter.css
+++ b/release/src/router/softcenter/softcenter/res/softcenter.css
@@ -62,3 +62,45 @@
 	width: 740px;
 	margin: 1px 0;
 }
+.ks_btn {
+	border: 1px solid #222;
+	font-size:10pt;
+	color: #fff;
+	padding: 5px 5px 5px 5px;
+	border-radius: 5px 5px 5px 5px;
+	width:14%;
+	vertical-align: middle;
+	background: linear-gradient(to bottom, #003333  0%, #000000 100%);
+}
+.ks_btn:hover {
+	border: 1px solid #222;
+	font-size:10pt;
+	color: #fff;
+	padding: 5px 5px 5px 5px;
+	border-radius: 5px 5px 5px 5px;
+	width:14%;
+	vertical-align: middle;
+	background: linear-gradient(to bottom, #27c9c9  0%, #279fd9 100%);
+}
+.soft_setting_log{
+	margin-top:10px;
+	display:block;
+	overflow:hidden;
+	outline: 1px solid #222;
+}
+.soft_setting_log1{
+	width:97%;
+	padding-top:4px;
+	padding-bottom:4px;
+	padding-left:4px;
+	padding-right:37px;
+	font-family:'Lucida Console';
+	font-size:11px;
+	line-height:1.5;
+	color:#FFFFFF;
+	outline:none;
+	overflow-x:hidden;
+	margin-top:1px;
+	border:0px solid #222;
+	background:#475A5F;
+}
diff --git a/release/src/router/softcenter/softcenter/scripts/ks_app_install.sh b/release/src/router/softcenter/softcenter/scripts/ks_app_install.sh
index 8e2c66861a..ea9e99ccff 100755
--- a/release/src/router/softcenter/softcenter/scripts/ks_app_install.sh
+++ b/release/src/router/softcenter/softcenter/scripts/ks_app_install.sh
@@ -1,285 +1,407 @@
 #!/bin/sh
-
-export KSROOT=/koolshare
-source $KSROOT/scripts/base.sh
-
-
-#From dbus to local variable
-eval $(dbus export softcenter_installing_)
 source /koolshare/scripts/base.sh
-export PERP_BASE=/koolshare/perp
-
-#softcenter_installing_module 	#正在安装的模块
-#softcenter_installing_todo 	#希望安装的模块
-#softcenter_installing_tick 	#上次安装开始的时间
-#softcenter_installing_version 	#正在安装的版本
-#softcenter_installing_md5 	#正在安装的版本的md5值
-#softcenter_installing_tar_url 	#模块对应的下载地址
-
-#softcenter_installing_status=		#尚未安装
-#softcenter_installing_status=0		#尚未安装
-#softcenter_installing_status=1		#已安装
-#softcenter_installing_status=2		#将被安装到jffs分区...
-#softcenter_installing_status=3		#正在下载中...请耐心等待...
-#softcenter_installing_status=4		#正在安装中...
-#softcenter_installing_status=5		#安装成功！请5秒后刷新本页面！...
-#softcenter_installing_status=6		#卸载中......
-#softcenter_installing_status=7		#卸载成功！
-#softcenter_installing_status=8		#没有检测到在线版本号！
-#softcenter_installing_status=9		#正在下载更新......
-#softcenter_installing_status=10	#正在安装更新...
-#softcenter_installing_status=11	#安装更新成功，5秒后刷新本页！
-#softcenter_installing_status=12	#下载文件校验不一致！
-#softcenter_installing_status=13	#然而并没有更新！
-#softcenter_installing_status=14	#正在检查是否有更新~
-#softcenter_installing_status=15	#检测更新错误！
-#softcenter_installing_status=16	#下载错误，代码：！
-#softcenter_installing_status=17	#卸载失败！请关闭插件后重试！
 
+###################################################
+#
+# Copyright (C) 2019/2020 kooldev
+#
+# 此脚为arm384软件中心安装脚本。
+# 软件中心地址: https://github.com/koolshare/armsoft
+#
+###################################################
+
+# softcenter_installing_todo		# 需要安装/卸载的插件，比如：linkease
+# softcenter_installing_name		# 上一个/正在安装的插件的名字，比如【易有云】
+# softcenter_installing_title		# 需要安装/卸载的插件名字，比如【易有云2.0】
+# softcenter_installing_version		# 需要安装插件的版本
+# softcenter_installing_md5			# 需要安装插件的md5值
+# softcenter_installing_tar_url		# 需要安装插件对应的下载地址
+
+LOG_FILE=/tmp/upload/soft_install_log.txt
+LOG_FILE_BACKUP=/tmp/upload/soft_install_log_backup.txt
+URL_SPLIT="/"
 softcenter_home_url=$(dbus get softcenter_home_url)
-CURR_TICK=$(date +%s)
+alias echo_date='echo 【$(TZ=UTC-8 date -R +%Y年%m月%d日\ %X)】:'
+eval $(dbus export softcenter_installing_)
 BIN_NAME=$(basename "$0")
 BIN_NAME="${BIN_NAME%.*}"
-if [ "$ACTION" != "" ]; then
-	BIN_NAME=$ACTION
-fi
 
-if [ "$(nvram get model)" == "GT-AC5300" ] || [ "$(nvram get model)" == "GT-AX11000" ] || [ -n "$(nvram get extendno | grep koolshare)" -a "$(nvram get productid)" == "RT-AC86U" ];then
-	ROG=1
-fi
+quit_ks_install(){
+	[ -n "${softcenter_installing_todo}" ] && rm -rf "/tmp/${softcenter_installing_todo}*"
+	dbus set softcenter_installing_todo=""
+	dbus set softcenter_installing_title=""
+	dbus set softcenter_installing_name=""
+	dbus set softcenter_installing_tar_url=""
+	dbus set softcenter_installing_version=""
+	dbus set softcenter_installing_md5=""
+	echo_date ============================= end =================================
+	echo XU6J03M6
+	exit
+}
 
-LOGGER() {
-#	echo $1
-	logger $1
+quit_ks_uninstall(){
+	dbus set softcenter_installing_todo=""
+	dbus set softcenter_installing_title=""
+	echo_date ============================= end =================================
+	echo XU6J03M6
+	exit
 }
 
-install_module() {
-	if [ "${softcenter_home_url}" = "" -o "${softcenter_installing_md5}" = "" -o "${softcenter_installing_version}" = "" ]; then
-		LOGGER "【软件中心】input error, something not found"
-		exit 1
-	fi
+jffs_space(){
+	local JFFS_AVAL=$(df | grep -w "/jffs" | awk '{print $4}')
+	echo ${JFFS_AVAL}
+}
 
-	if [ "${softcenter_installing_tick}" = "" ]; then
-		export softcenter_installing_tick=0
-	fi
-	LAST_TICK=$(expr ${softcenter_installing_tick} + 20)
-	if [ "${LAST_TICK}" -ge "${CURR_TICK}" -a "${softcenter_installing_module}" != "" ]; then
-		LOGGER "【软件中心】module ${softcenter_installing_module} is installing"
-		exit 2
+install_ks_module() {
+	# 1. before install, detect if some value (passed from web) exist.
+	if [ -z "${softcenter_home_url}" -o -z "${softcenter_installing_md5}" -o -z "${softcenter_installing_version}" -o -z "${softcenter_installing_tar_url}" -o -z "${softcenter_installing_todo}" -o -z "${softcenter_installing_title}" ]; then
+		echo_date "-------------------------------------------------------------------"
+		echo_date "软件中心：参数错误，退出！"
+		echo_date "这种情况是极少的，如果你遇到了，建议重启路由器后再尝试卸载操作！"
+		echo_date "如果仍然不能解决，只能建议重置软件中心或者重置路由器已解决问题！"
+		echo_date "-------------------------------------------------------------------"
+		echo_date "退出本次插件安装！"
+		quit_ks_install
 	fi
 
-	if [ "${softcenter_installing_todo}" = "" ]; then
-		#curr module name not found
-		LOGGER "【软件中心】module name not found"
-		exit 3
+	# 2. detect ks_app_install.sh process
+	local KS_PID=$$
+	local KS_SCRIPT_PID=$(ps | grep "ks_app_install.sh" | grep -vw "grep" | grep -vw "${KS_PID}")
+	if [ -n "${KS_SCRIPT}" ];then
+		if [ -n "${softcenter_installing_name}" ];then
+			# 如果有其它ks_app_install.sh在运行，且${softcenter_installing_name}不为空，说明有插件正在安装/卸载，此时应该退出安装
+			echo_date "-------------------------------------------------------------------"
+			echo_date "软件中心：检测到上个插件：【${softcenter_installing_name}】正在安装/卸载..."
+			echo_date "请等待上个插件安装/卸载完毕后再试！"
+			echo_date "如果等待很久仍然是该错误，请重启路由后再试！"
+			echo_date "-------------------------------------------------------------------"
+			echo_date "退出本次插件安装！"
+			quit_ks_install
+		else
+			# 如果有其它ks_app_install.sh在运行，且${softcenter_installing_name}为空，那么杀掉该进程，然后继续安装
+			kill -9 ${KS_SCRIPT_PID}
+		fi
 	fi
 
-	# Just ignore the old installing_module
-	export softcenter_installing_module=${softcenter_installing_todo}
-	export softcenter_installing_tick=$(date +%s)
-	dbus set softcenter_installing_status="2"
-	sleep 1
-	dbus save softcenter_installing_
-
-	URL_SPLIT="/"
-	#OLD_MD5=$(dbus get softcenter_module_${softcenter_installing_module_md5})
-	OLD_VERSION=$(dbus get softcenter_module_${softcenter_installing_module}_version)
-	HOME_URL=$(dbus get softcenter_home_url)
-	TAR_URL=${HOME_URL}${URL_SPLIT}${softcenter_installing_tar_url}
-	FNAME=$(basename ${softcenter_installing_tar_url})
-
-	if [ "$OLD_VERSION" = "" ]; then
-		OLD_VERSION=0
+	# 3. 检查上次插件安装是否正确，并且给与警告
+	if [ -n "${softcenter_installing_name}" ];then
+		echo_date "软件中心：检测到上次安装的插件【${softcenter_installing_name}】没有正确安装！"
+		echo_date "软件中心：如果已安装里已经有【${softcenter_installing_name}】插件图标，建议将其卸载后重新安装！"
 	fi
 
-	CMP=$(versioncmp ${softcenter_installing_version} ${OLD_VERSION})
-	if [ -f "/koolshare/webs/Module_${softcenter_installing_module}.sh" -o "${softcenter_installing_todo}" = "softcenter" ]; then
-		CMP="-1"
+	# 4. 如果安装出现异常，比如 ks_app_install.sh进程被意外中断，$softcenter_installing_name值将得到保留，以进行上面第2、3步的检测。
+	softcenter_installing_name=${softcenter_installing_title}
+	dbus set softcenter_installing_name=${softcenter_installing_title}
+
+	# 5. 比较版本号
+	local OLD_VERSION=$(dbus get softcenter_module_${softcenter_installing_todo}_version)
+	[ -z "$OLD_VERSION" ] && OLD_VERSION=0
+	local CMP=$(versioncmp ${softcenter_installing_version} ${OLD_VERSION})
+	if [ "${softcenter_installing_todo}" == "softcenter" ]; then
+		local CMP="-1"
+	fi
+	if [ "$CMP" != "-1" ]; then
+		echo_date "-------------------------------------------------------------------"
+		echo_date "插件【${softcenter_installing_name}】本地版本号已经是最新版本，无须更新！"
+		echo_date "插件【${softcenter_installing_name}】本地版本号：${OLD_VERSION}"
+		echo_date "插件【${softcenter_installing_name}】在线版本号：${softcenter_installing_version}"
+		echo_date "目前软件中心不支持插件降级为低版本，或者同版本平刷！"
+		echo_date "可能是软件中心维护人员手残推送了错误的版本号！请无视或到koolshare论坛反馈。"
+		echo_date "-------------------------------------------------------------------"
+		echo_date "退出本次插件安装！"
+		quit_ks_install
 	fi
-	if [ "$CMP" = "-1" ]; then
 
+	# 6. 下载准备，再删除一次插件包，避免 xxx.tar.gz 下载为 xxx.tar.gz1等名字
+	local FNAME=$(basename ${softcenter_installing_tar_url})
+	echo_date "插件【${softcenter_installing_title}】将会被安装到/jffs分区..."
 	cd /tmp
 	rm -f ${FNAME}
-	rm -rf "/tmp/$softcenter_installing_module"
-	dbus set softcenter_installing_status="3"
-	sleep 1
-	wget -t 2 -T 20 --dns-timeout=15 --no-check-certificate -q ${TAR_URL}
-	RETURN_CODE=$?
+	rm -rf "/tmp/$softcenter_installing_todo"
 
+	# 7. 开始下载
+	local TAR_URL=${softcenter_home_url}${URL_SPLIT}${softcenter_installing_tar_url}
+	echo_date "插件【${softcenter_installing_name}】的压缩包正在下载中，请稍候..."
+	### echo_date "下载地址：${softcenter_home_url}${URL_SPLIT}${softcenter_installing_tar_url}"
+	wget -t 2 -T 20 --dns-timeout=15 --no-check-certificate ${TAR_URL}
+	RETURN_CODE=$?
 	if [ "$RETURN_CODE" != "0" ]; then
-		dbus set softcenter_installing_status="16"
-		sleep 3
-		dbus set softcenter_installing_status="0"
-		dbus set softcenter_installing_module=""
-		dbus set softcenter_installing_todo=""
-		LOGGER "【软件中心】wget ${TAR_URL} error, ${RETURN_CODE}"
-		exit ${RETURN_CODE}
+		echo_date "-------------------------------------------------------------------"
+		echo_date "压缩包下载错误，错误代码：$RETURN_CODE"
+		echo_date "出现该错误一般是本地网络问题，比如本地DNS无法解析软件中心域名等..."
+		echo_date "建议关闭代理、更换路由器DNS后再试，或者使用下方提供的插件地址手动下载后离线安装。"
+		echo_date "下载地址：${softcenter_home_url}${URL_SPLIT}${softcenter_installing_tar_url}"
+		echo_date "-------------------------------------------------------------------"
+		echo_date "退出本次在线安装！"
+		quit_ks_install
 	fi
 
+	# 8. 校验下载
+	echo_date "下载完毕，准备校验..."
 	md5sum_gz=$(md5sum /tmp/${FNAME} | sed 's/ /\n/g'| sed -n 1p)
 	if [ "$md5sum_gz"x != "$softcenter_installing_md5"x ]; then
-		LOGGER "【软件中心】md5 not equal $md5sum_gz"
-		dbus set softcenter_installing_status="12"
-		rm -f ${FNAME}
-		sleep 3
-
-		dbus set softcenter_installing_status="0"
-		dbus set softcenter_installing_module=""
-		dbus set softcenter_installing_todo=""
-
-		rm -f ${FNAME}
-		rm -rf "/tmp/$softcenter_installing_module"
-		exit
-	else
-		tar -zxf ${FNAME}
-		dbus set softcenter_installing_status="4"
-
-		if [ ! -f /tmp/${softcenter_installing_module}/install.sh ]; then
-			dbus set softcenter_installing_status="0"
-			dbus set softcenter_installing_module=""
-			dbus set softcenter_installing_todo=""
-
-			#rm -f ${FNAME}
-			#rm -rf "/tmp/${softcenter_installing_module}"
-
-			LOGGER "【软件中心】package hasn't install.sh"
-			exit 5
-		fi
-
-		if [ -f /tmp/${softcenter_installing_module}/uninstall.sh ]; then
-			chmod 755 /tmp/${softcenter_installing_module}/uninstall.sh
-			mv /tmp/${softcenter_installing_module}/uninstall.sh /koolshare/scripts/uninstall_${softcenter_installing_todo}.sh
-		fi
-
-		if [ -d /tmp/${softcenter_installing_module}/GT-AC5300 -a "$ROG" == "1" ]; then
-			cp -rf /tmp/${softcenter_installing_module}/GT-AC5300/* /tmp/${softcenter_installing_module}/
-		fi
-
-		if [ -d /tmp/${softcenter_installing_module}/ROG -a "$ROG" == "1" ]; then
-			cp -rf /tmp/${softcenter_installing_module}/ROG/* /tmp/${softcenter_installing_module}/
-		fi
+		echo_date "-------------------------------------------------------------------"
+		echo_date "下载的插件压缩包文件校验不一致！退出本次插件安装！"
+		echo_date "插件【${softcenter_installing_name}】在线版本md5：${softcenter_installing_md5}"
+		echo_date "插件【${softcenter_installing_name}】下载版本md5：${md5sum_gz}"
+		echo_date "建议重启/重置路由器后重试，或者使用下方提供的插件地址手动下载后离线安装。"
+		echo_date "下载地址：${softcenter_home_url}${URL_SPLIT}${softcenter_installing_tar_url}"
+		echo_date "-------------------------------------------------------------------"
+		echo_date "退出本次在线安装！"
+		quit_ks_install
+	fi
 
-		chmod a+x /tmp/${softcenter_installing_module}/install.sh
-		sh /tmp/${softcenter_installing_module}/install.sh
-		sleep 3
+	# 9. 解压插件
+	echo_date "校验成功，准备解压..."
+	tar -zxf ${FNAME}
+	if [ "$?" != "0" ]; then
+		echo_date "-------------------------------------------------------------------"
+		echo_date "错误：插件压缩包解压失败！退出本次插件安装！"
+		echo_date "建议重启/重置路由器后重试。"
+		echo_date "-------------------------------------------------------------------"
+		echo_date "退出本次在线安装！"
+		quit_ks_install
+	fi
 
-		rm -f ${FNAME}
-		rm -rf "/tmp/$softcenter_installing_module"
+	# 10. 检查install.sh
+	if [ ! -f /tmp/${softcenter_installing_todo}/install.sh ]; then
+		echo_date "-------------------------------------------------------------------"
+		echo_date "插件包内未找到 install.sh 安装脚本！退出本次安装！"
+		echo_date "建议重启/重置路由器后重试，或者到koolshare论坛反馈！"
+		echo_date "-------------------------------------------------------------------"
+		echo_date "退出本次在线安装！"
+		quit_ks_install
+	fi
 
-		if [ "$softcenter_installing_module" != "softcenter" ]; then
-			dbus set softcenter_module_${softcenter_installing_module}_md5=${softcenter_installing_md5}
-			dbus set softcenter_module_${softcenter_installing_module}_version=${softcenter_installing_version}
-			dbus set softcenter_module_${softcenter_installing_module}_install=1
-			dbus set ${softcenter_installing_module}_version=${softcenter_installing_version}
-		else
-			dbus set softcenter_version=${softcenter_installing_version};
-			dbus set softcenter_md5=${softcenter_installing_md5}
-		fi
-		dbus set softcenter_installing_module=""
-		dbus set softcenter_installing_todo=""
-		dbus set softcenter_installing_status="1"
+	# 11. 检查jffs空间
+	echo_date "解压成功，准备安装！"
+	### echo_date "检测jffs分区剩余空间..."
+	local JFFS_AVAL=$(df | grep -w "/jffs" | awk '{print $4}')
+	local FOLDER_SIZE=$(du -s /tmp/${softcenter_installing_todo} | awk '{print $1}')
+	local JFFS_NEED=${FOLDER_SIZE}
+	local TAR_SIZE=$(du -s /tmp/${FNAME} | awk '{print $1}')
+	### echo_date "插件文件夹大小：${JFFS_NEED}KB"
+	### echo_date "插件压缩包大小：${TAR_SIZE}KB"
+	if [ "${JFFS_AVAL}" -lt "${JFFS_NEED}" ];then
+		echo_date "-------------------------------------------------------------------"
+		echo_date "软件中心：当前jffs分区剩余${JFFS_AVAL}KB, 插件安装大致需要${JFFS_NEED}KB，空间不足！"
+		echo_date "请清理jffs分区内不要的文件，或者使用USB2JFFS插件对jffs分区进行扩容后再试！！"
+		echo_date "-------------------------------------------------------------------"
+		echo_date "本次插件安装失败！退出！"
+		quit_ks_install
+	fi
+	echo_date "软件中心：当前jffs分区剩余：${JFFS_AVAL}KB, 空间满足，继续安装！"
+
+	# 软件中心提供的插件已经明确区分了平台，但是某些以module形式存在的插件还没有加校验
+	# 所以目前校验暂时在离线安装里做，避免用户装错插件，在线安装这里暂时不做校验
+	# # 12. 检查.valid
+	# if [ ! -f "/tmp/${softcenter_installing_todo}/.valid" ];then
+	# 	echo_date "软件中心：插件包内未找到 .valid 校验文件！退出本次安装！"
+	# 	quit_ks_install
+	# fi
+
+	# 13. 检查.valid 字符串
+	# if [ -z "$(grep arm384 /tmp/${softcenter_installing_todo}/.valid)" ];then
+	# 	echo_date "软件中心：该插件包不能在本平台安装！"
+	# 	quit_ks_install
+	# fi
+
+	# 14. 复制uninstall.sh，在运行install.sh之前进行，避免安装包/文件夹被install.sh删掉
+	if [ -f /tmp/${softcenter_installing_todo}/uninstall.sh ]; then
+		chmod 755 /tmp/${softcenter_installing_todo}/uninstall.sh
+		cp -rf /tmp/${softcenter_installing_todo}/uninstall.sh /koolshare/scripts/uninstall_${softcenter_installing_todo}.sh
 	fi
 
+	# 17. 运行install.sh进行插件安装
+	echo_date "使用插件【${softcenter_installing_name}】提供的install.sh脚本进行安装..."
+	[ "${softcenter_installing_todo}" != "softcenter" ] && echo_date =========================== step 2 ================================
+	chmod a+x /tmp/${softcenter_installing_todo}/install.sh
+	sed -i "s/ 384/ 386/g" /tmp/${softcenter_installing_todo}/install.sh
+	# 使用start-stop-daemon，而不是shell fork，避免可能得install.sh问题导致ks_app_install.sh卡死
+	# sh /tmp/${softcenter_installing_todo}/install.sh
+	start-stop-daemon -S -q -x /tmp/${softcenter_installing_todo}/install.sh 2>&1
+	if [ "$?" != "0" ];then
+		rm -rf /koolshare/scripts/uninstall_${softcenter_installing_todo}.sh
+		echo_date "-------------------------------------------------------------------"
+		echo_date "软件中心：插件安装失败！请联系插件作者或者koolshare开发组以解决问题！"
+		echo_date "-------------------------------------------------------------------"
+		echo_date "本次插件安装失败！退出！"
+		quit_ks_install
+	fi
+	[ "${softcenter_installing_todo}" != "softcenter" ] && echo_date =========================== step 3 ================================
+
+	# 18. 安装完毕，写入安装相关的值
+	if [ "$softcenter_installing_todo" != "softcenter" ]; then
+		echo_date "为插件【${softcenter_installing_name}】设置版本号：${softcenter_installing_version}"
+		dbus set softcenter_module_${softcenter_installing_todo}_md5=${softcenter_installing_md5}
+		dbus set softcenter_module_${softcenter_installing_todo}_version=${softcenter_installing_version}
+		dbus set softcenter_module_${softcenter_installing_todo}_install=1
+		dbus set ${softcenter_installing_todo}_version=${softcenter_installing_version}
 	else
-		LOGGER "【软件中心】current version is newest version"
-		dbus set softcenter_installing_status="13"
-		sleep 3
-
-		dbus set softcenter_installing_status="0"
-		dbus set softcenter_installing_module=""
-		dbus set softcenter_installing_todo=""
+		echo_date "为软件中心设置版本号：${softcenter_installing_version}"
+		dbus set softcenter_version=${softcenter_installing_version};
+		dbus set softcenter_md5=${softcenter_installing_md5}
 	fi
-}
 
-uninstall_module() {
-	if [ "${softcenter_installing_tick}" = "" ]; then
-		export softcenter_installing_tick=0
+	# 19. 安装完毕，打印剩余空间
+	local JFFS_AVAL_2=$(jffs_space)
+	local JFFS_USED=$(($JFFS_AVAL - $JFFS_AVAL_2))
+	if [ "${JFFS_USED}" -ge "0" ];then
+		echo_date "软件中心：本次安装占用了${JFFS_USED}KB空间，目前jffs分区剩余容量：${JFFS_AVAL_2}KB"
+	elif [ "${JFFS_USED}" -lt "0" ];then
+		local JFFS_RELEASED=${JFFS_USED#-}
+		echo_date "软件中心：本次安装释放了${JFFS_RELEASED}KB空间，目前jffs分区剩余容量：${JFFS_AVAL_2}KB"
 	fi
-	LAST_TICK=$(expr ${softcenter_installing_tick} + 20)
-	if [ "${LAST_TICK}" -ge "${CURR_TICK}" -a "${softcenter_installing_module}" != "" ]; then
-		LOGGER "【软件中心】module ${softcenter_installing_module} is installing"
-		exit 2
+	if [ "${JFFS_AVAL_2}" -lt "2000" ];then
+		echo_date "软件中心：注意！目前jffs分区剩余容量只剩下：${JFFS_AVAL_2}KB，已不足2MB！"
 	fi
 
-	if [ "${softcenter_installing_todo}" = "" -o "${softcenter_installing_todo}" = "softcenter" ]; then
-		#curr module name not found
-		LOGGER "【软件中心】module name not found"
-		exit 3
+	# 20. 安装完毕，删除相关值和安装包
+	echo_date "安装完毕！"
+	quit_ks_install
+}
+
+uninstall_ks_module() {
+	local JFFS_AVAL=$(df | grep -w "/jffs" | awk '{print $4}')
+
+	# 1. before uninstall, detect if some value exist.
+	if [ -z "${softcenter_installing_todo}" -o -z "${softcenter_installing_title}" -o "${softcenter_installing_todo}" == "softcenter" ]; then
+		echo_date "-------------------------------------------------------------------"
+		echo_date "软件中心：参数错误，退出！"
+		echo_date "这种情况是极少的，如果你遇到了，建议重启路由器后再尝试卸载操作！"
+		echo_date "如果仍然不能解决，只能建议重置软件中心或者重置路由器已解决问题！"
+		echo_date "-------------------------------------------------------------------"
+		echo_date "退出本次插件卸载！"
+		quit_ks_uninstall
 	fi
 
+	# 2. detect if plugin is running
 	local ENABLED=$(dbus get ${softcenter_installing_todo}_enable)
 	if [ "${ENABLED}" == "1" ]; then
-		LOGGER "【软件中心】please disable ${softcenter_installing_module} then try again"
-		dbus set softcenter_installing_status="17"
-		sleep 3
-		dbus set softcenter_installing_status="0"
-		exit 4
+		echo_date "-------------------------------------------------------------------"
+		echo_date "软件中心：插件【${softcenter_installing_title}】无法卸载！"
+		echo_date "因为插件【${softcenter_installing_title}】已经开启！你必须先将其关闭后才能进行卸载操作！"
+		echo_date "-------------------------------------------------------------------"
+		echo_date "退出本次插件卸载！"
+		quit_ks_uninstall
 	fi
 
-	# Just ignore the old installing_module
-	export softcenter_installing_module=${softcenter_installing_todo}
-	export softcenter_installing_tick=$(date +%s)
-	export softcenter_installing_status="6"
-	dbus save softcenter_installing_
+	# 3. try to call uninstall script
+	echo_date "开始卸载【${softcenter_installing_title}】插件，请稍候！"
+	if [ -f /koolshare/scripts/${softcenter_installing_todo}_uninstall.sh]; then
+		echo_date "使用插件【${softcenter_installing_title}】自带卸载脚本：${softcenter_installing_todo}_uninstall.sh 卸载！"
+ 		# sh /koolshare/scripts/${softcenter_installing_todo}_uninstall.sh
+ 		start-stop-daemon -S -q -x /koolshare/scripts/${softcenter_installing_todo}_uninstall.sh 2>&1
+	elif [ -f "/koolshare/scripts/uninstall_${softcenter_installing_todo}.sh" ]; then
+		echo_date "使用插件【${softcenter_installing_title}】自带卸载脚本：uninstall_${softcenter_installing_todo}.sh 卸载！"
+		# sh /koolshare/scripts/uninstall_${softcenter_installing_todo}.sh
+ 		start-stop-daemon -S -q -x /koolshare/scripts/uninstall_${softcenter_installing_todo}.sh 2>&1
+	else
+		echo_date "没有找到插件【${softcenter_installing_title}】自带的卸载脚本，使用软件中心的卸载功能进行卸载！"
+		rm -rf /koolshare/${softcenter_installing_todo} >/dev/null 2>&1
+		rm -rf /koolshare/bin/${softcenter_installing_todo} >/dev/null 2>&1
+		rm -rf /koolshare/init.d/*${softcenter_installing_todo}* >/dev/null 2>&1
+		rm -rf /koolshare/scripts/${softcenter_installing_todo}*.sh >/dev/null 2>&1
+		rm -rf /koolshare/res/icon-${softcenter_installing_todo}.png >/dev/null 2>&1
+		rm -rf /koolshare/webs/Module_${softcenter_installing_todo}.asp >/dev/null 2>&1
+	fi
 
-	dbus remove softcenter_module_${softcenter_installing_module}_md5
-	dbus remove softcenter_module_${softcenter_installing_module}_version
-	dbus remove softcenter_module_${softcenter_installing_module}_install
-	dbus remove softcenter_module_${softcenter_installing_module}_description
-	dbus remove softcenter_module_${softcenter_installing_module}_name
-	dbus remove softcenter_module_${softcenter_installing_module}_title
+	# 4. remove software center value for specific plugin
+	if [ -n "$(dbus get softcenter_module_${softcenter_installing_todo}_install)" ];then
+		echo_date "移除插件【${softcenter_installing_title}】储存的相关参数..."
+		dbus remove softcenter_module_${softcenter_installing_todo}_md5
+		dbus remove softcenter_module_${softcenter_installing_todo}_version
+		dbus remove softcenter_module_${softcenter_installing_todo}_install
+		dbus remove softcenter_module_${softcenter_installing_todo}_description
+		dbus remove softcenter_module_${softcenter_installing_todo}_name
+		dbus remove softcenter_module_${softcenter_installing_todo}_title
+	fi
 
-	txt=$(dbus list ${softcenter_installing_todo})
+	# 5. remove plugin dbus value
+	local txt=$(dbus list ${softcenter_installing_todo})
 	printf "%s\n" "$txt" |
 	while IFS= read -r line; do
 		line2="${line%=*}"
 		if [ "${line2}" != "" ]; then
+			echo_date "移除参数：${line2}"
 			dbus remove ${line2}
 		fi
 	done
 
-	sleep 3
-	dbus set softcenter_installing_module=""
-	dbus set softcenter_installing_status="7"
-	dbus set softcenter_installing_todo=""
+	# 6. try to remove broken link
+	local LINKS=$(ls -lh /koolshare/init.d|grep -E "^l"|awk '{print $9}')
+	if [ -n "${LINKS}" ];then
+		for link in ${LINKS}
+		do
+			if [ ! -f /koolshare/init.d/$link ];then
+				echo_date "移除文件：/koolshare/init.d/$link"
+				rm -rf /koolshare/init.d/$link
+			fi
+		done
+	fi
 
-	#try to call uninstall script
-	if [ -f /koolshare/scripts/${softcenter_installing_todo}_uninstall.sh]; then
- 		sh /koolshare/scripts/${softcenter_installing_todo}_uninstall.sh
-	elif [ -f "/koolshare/scripts/uninstall_${softcenter_installing_todo}.sh" ]; then
-		sh /koolshare/scripts/uninstall_${softcenter_installing_todo}.sh
+	# 7. alert jffs_space uasge
+	local JFFS_AVAL_2=$(jffs_space)
+	local JFFS_RELEASED=$(($JFFS_AVAL_2 - $JFFS_AVAL))
+	echo_date "软件中心：本次卸载释放了${JFFS_RELEASED}KB，目前jffs分区剩余容量：${JFFS_AVAL_2}KB"
+
+	# 7. finish uninstall
+	echo_date "卸载成功！"
+	quit_ks_uninstall
+}
+
+download_softcenter_log(){
+	rm -rf /tmp/files
+	rm -rf /koolshare/webs/files
+	mkdir -p /tmp/files
+	ln -sf /tmp/files /koolshare/webs/files
+	if [ -f "$LOG_FILE_BACKUP" ];then
+		cp -rf $LOG_FILE_BACKUP /tmp/files/softcenter_log.txt
+		sed -i 's/XU6J03M6//g' /tmp/files/softcenter_log.txt
 	else
-		if [ -n "${softcenter_installing_todo}" ]; then
-			rm -rf /koolshare/${softcenter_installing_todo}
-			rm -rf /koolshare/bin/${softcenter_installing_todo}
-			rm -rf /koolshare/init.d/*${softcenter_installing_todo}*
-			rm -rf /koolshare/scripts/${softcenter_installing_todo}*.sh
-			rm -rf /koolshare/res/icon-${softcenter_installing_todo}.png
-			rm -rf /koolshare/webs/Module_${softcenter_installing_todo}.asp
-		fi
+		echo "日志为空" > /tmp/files/softcenter_log.txt
 	fi
 }
 
-#LOGGER $BIN_NAME
+clean_backup_log() {
+	local LOG_MAX=1000
+	[ $(wc -l "$LOG_FILE_BACKUP" | awk '{print $1}') -le "$LOG_MAX" ] && return
+	local logdata=$(tail -n 500 "$LOG_FILE_BACKUP")
+	echo "$logdata" > $LOG_FILE_BACKUP 2> /dev/null
+	unset logdata
+}
+
+backup_log_file(){
+	sleep 3
+	clean_backup_log
+	echo XU6J03M6 | tee -a $LOG_FILE
+	cat $LOG_FILE >> $LOG_FILE_BACKUP
+}
+
+# echo_date \$2: $2 | tee -a $LOG_FILE
 case $2 in
-update)
-	http_response $1
-	install_module
-	;;
-install)
+download_log)
+	download_softcenter_log
 	http_response $1
-	install_module
 	;;
-ks_app_install)
+clean_log)
+	echo XU6J03M6 | tee $LOG_FILE_BACKUP
 	http_response $1
-	install_module
 	;;
 ks_app_remove)
+	true > $LOG_FILE
 	http_response $1
-	uninstall_module
+	echo_date ============================ start ================================ | tee -a $LOG_FILE
+	uninstall_ks_module | tee -a $LOG_FILE
+	backup_log_file | tee -a $LOG_FILE
 	;;
-*)
+install|update|ks_app_install|*)
+	true > $LOG_FILE
 	http_response $1
-	install_module
+	echo_date =========================== step 1 ================================ | tee -a $LOG_FILE
+	install_ks_module | tee -a $LOG_FILE
+	#install_ks_module >> $LOG_FILE 2>&1
+	echo_date ============================= end =================================
+	backup_log_file | tee -a $LOG_FILE
 	;;
 esac
diff --git a/release/src/router/softcenter/softcenter/scripts/ks_tar_install.sh b/release/src/router/softcenter/softcenter/scripts/ks_tar_install.sh
index 40fead916f..0655c56314 100755
--- a/release/src/router/softcenter/softcenter/scripts/ks_tar_install.sh
+++ b/release/src/router/softcenter/softcenter/scripts/ks_tar_install.sh
@@ -1,15 +1,20 @@
 #!/bin/sh
 
-# for hnd platform
+# for arm384 platform
 
 export KSROOT=/koolshare
 source $KSROOT/scripts/base.sh
 alias echo_date='echo 【$(date +%Y年%m月%d日\ %X)】:'
-eval `dbus export soft`
+LOG_FILE=/tmp/upload/soft_log.txt
+LOG_FILE_BACKUP=/tmp/upload/soft_install_log_backup.txt
+eval $(dbus export soft)
 TARGET_DIR=/tmp/upload
-if [ "`nvram get model`" == "GT-AC5300" ] || [ "`nvram get model`" == "GT-AX11000" ] || [ -n "`nvram get extendno | grep koolshare`" -a "`nvram get productid`" == "RT-AC86U" ];then
-	ROG=1
-fi
+MODEL=$(nvram get productid)
+
+jffs_space(){
+	local JFFS_AVAL=$(df | grep -w "/jffs" | awk '{print $4}')
+	echo ${JFFS_AVAL}
+}
 
 clean(){
 	[ -n "$name" ] && rm -rf /tmp/$name >/dev/null 2>&1
@@ -20,8 +25,25 @@ clean(){
 	dbus remove soft_name
 }
 
+detect_package(){
+	local TEST_WORD="$1"
+	local ILLEGAL_KEYWORDS="ss|ssr|shadowsocks|shadowsocksr|v2ray|trojan|clash|wireguard|koolss|brook|fuck"
+	local KEY_MATCH=$(echo "${TEST_WORD}" | grep -Eo "$ILLEGAL_KEYWORDS")
+
+	if [ -n "${KEY_MATCH}" ]; then
+		echo_date =======================================================
+		echo_date "检测到离线安装包：${soft_name} 含非法关键词！！！"
+		echo_date "根据法律规定，koolshare软件中心将不会安装此插件！！！"
+		echo_date "删除相关文件并退出..."
+		echo_date =======================================================
+		clean
+		exit 1
+	fi
+}
+
 install_tar(){
-	name=`echo "$soft_name"|sed 's/.tar.gz//g'|awk -F "_" '{print $1}'|awk -F "-" '{print $1}'`
+	detect_package "$soft_name"
+	name=$(echo "$soft_name"|sed 's/.tar.gz//g'|awk -F "_" '{print $1}'|awk -F "-" '{print $1}')
 	INSTALL_SUFFIX=_install
 	VER_SUFFIX=_version
 	NAME_SUFFIX=_name
@@ -42,78 +64,102 @@ install_tar(){
 			echo_date 估计是错误或者不完整的的离线安装包！
 			echo_date 删除相关文件并退出...
 			clean
-			dbus remove "softcenter_module_$MODULE_NAME$INSTALL_SUFFIX"
 			echo_date ======================== end ============================
 			echo XU6J03M6
 			exit
 		fi
 
-		if [ -f "/tmp/$name/.valid" ] && [ "`cat /tmp/$name/.valid`" == "arm384" ];then
-			continue
-		else
-			echo_date 你上传的离线安装包不是arm384平台的离线包！！！
-			echo_date 请上传正确的离线安装包！！！
-			echo_date 删除相关文件并退出...
-			clean
-			dbus remove "softcenter_module_$MODULE_NAME$INSTALL_SUFFIX"
-			echo_date ======================== end ============================
-			echo XU6J03M6
-			exit		
-		fi
-		
 		if [ -f /tmp/$name/install.sh ];then
 			INSTALL_SCRIPT=/tmp/$name/install.sh
 		else
-			INSTALL_SCRIPT_NU=`find /tmp -name "install.sh"|wc -l` 2>/dev/null
-			[ "$INSTALL_SCRIPT_NU" == "1" ] && INSTALL_SCRIPT=`find /tmp -name "install.sh"` || INSTALL_SCRIPT=""
+			INSTALL_SCRIPT_NU=$(find /tmp -name "install.sh"|wc -l) 2>/dev/null
+			[ "$INSTALL_SCRIPT_NU" == "1" ] && INSTALL_SCRIPT=$(find /tmp -name "install.sh") || INSTALL_SCRIPT=""
 		fi
 
 		if [ -n "$INSTALL_SCRIPT" -a -f "$INSTALL_SCRIPT" ];then
-			SCRIPT_AB_DIR=`dirname $INSTALL_SCRIPT`
+			SCRIPT_AB_DIR=$(dirname $INSTALL_SCRIPT)
 			MODULE_NAME=${SCRIPT_AB_DIR##*/}
-			echo_date 准备安装$MODULE_NAME插件！
+
+			detect_package "${MODULE_NAME}"
+
+			# 检查jffs空间，不可描述不做检测，交给插件自己处理
+			local JFFS_AVAL=$(jffs_space)
+			if [ "${MODULE_NAME}" != "shadowsocks" ];then
+				echo_date "检测jffs分区剩余空间..."
+				local JFFS_NEED=$(du -s /tmp/${MODULE_NAME} | awk '{print $1}')
+				local TAR_SIZE=$(du -s /tmp/${soft_name} | awk '{print $1}')
+				### echo_date "JFFS剩余空间：${JFFS_AVAL}KB"
+				### echo_date "插件文件夹大小：${JFFS_NEED}KB"
+				### echo_date "插件压缩包大小：${TAR_SIZE}KB"
+				if [ "${JFFS_AVAL}" -lt "${JFFS_NEED}" ];then
+					echo_date "-------------------------------------------------------------------"
+					echo_date "软件中心：当前jffs分区剩余${JFFS_AVAL}KB, 插件安装大致需要${JFFS_NEED}KB，空间不足！"
+					echo_date "请清理jffs分区内不要的文件，或者使用USB2JFFS插件对jffs分区进行扩容后再试！！"
+					echo_date "-------------------------------------------------------------------"
+					echo_date "本次插件安装失败！退出！"
+					clean
+					echo_date ======================== end ============================
+					echo XU6J03M6
+					exit
+				fi
+				echo_date "软件中心：当前jffs分区剩余：${JFFS_AVAL}KB, 空间满足，继续安装！"
+			fi
+
+			# 检查下安装包是否是hnd的
+			if [ -f "${SCRIPT_AB_DIR}/.valid" -a -n "$(grep arm384 ${SCRIPT_AB_DIR}/.valid)" ];then
+				continue
+			elif [ "${MODULE_NAME}" == "shadowsocks" ];then
+				# hnd的不可描述包没有校验字符串，避免安装失败
+				continue
+			else
+				echo_date 你上传的离线安装包不是arm384平台的离线包！！！
+				echo_date 请上传正确的离线安装包！！！
+				echo_date 删除相关文件并退出...
+				clean
+				dbus remove "softcenter_module_${MODULE_NAME}${INSTALL_SUFFIX}"
+				echo_date ======================== end ============================
+				echo XU6J03M6
+				exit
+			fi
+
+			echo_date 准备安装${MODULE_NAME}插件！
 			echo_date 找到安装脚本！
 			chmod +x $INSTALL_SCRIPT >/dev/null 2>&1
+			sed -i "s/ 384/ 386/g" $INSTALL_SCRIPT >/dev/null 2>&1
 			echo_date 运行安装脚本...
 			echo_date ====================== step 2 ===========================
 
-			if [ -d /tmp/$MODULE_NAME/GT-AC5300 -a "$ROG" == "1" ]; then
-				cp -rf /tmp/$MODULE_NAME/GT-AC5300/* /tmp/$MODULE_NAME/
-			fi
-
-			if [ -d /tmp/$MODULE_NAME/ROG -a "$ROG" == "1" ]; then
-				cp -rf /tmp/$MODULE_NAME/ROG/* /tmp/$MODULE_NAME/
-			fi
-			
-			sleep 1
 			start-stop-daemon -S -q -x $INSTALL_SCRIPT 2>&1
 			if [ "$?" != "0" ];then
-				echo_date 因为$MODULE_NAME插件安装失败！退出离线安装！
+				echo_date 因为${MODULE_NAME}插件安装失败！退出离线安装！
 				clean
-				dbus remove "softcenter_module_$MODULE_NAME$INSTALL_SUFFIX"
+				dbus remove "softcenter_module_${MODULE_NAME}${INSTALL_SUFFIX}"
 				echo_date ======================== end ============================
 				echo XU6J03M6
 				exit
 			fi
+
+			sed -i '/rogcss/d' /koolshare/webs/Module_${MODULE_NAME}.asp >/dev/null 2>&1
+
 			echo_date ====================== step 3 ===========================
-			dbus set "softcenter_module_$MODULE_NAME$NAME_SUFFIX=$MODULE_NAME"
-			dbus set "softcenter_module_$MODULE_NAME$INSTALL_SUFFIX=1"
+			dbus set "softcenter_module_${MODULE_NAME}${NAME_SUFFIX}=${MODULE_NAME}"
+			dbus set "softcenter_module_${MODULE_NAME}${INSTALL_SUFFIX}=1"
 			if [ -n "$soft_install_version" ];then
-				dbus set "softcenter_module_$MODULE_NAME$VER_SUFFIX=$soft_install_version"
+				dbus set "softcenter_module_${MODULE_NAME}${VER_SUFFIX}=$soft_install_version"
 				echo_date "从插件文件名中获取到了版本号：$soft_install_version"
 			else
-				if [ -z "`dbus get softcenter_module_$MODULE_NAME$VER_SUFFIX`" ];then
-					dbus set "softcenter_module_$MODULE_NAME$VER_SUFFIX=0.1"
+				if [ -z "$(dbus get softcenter_module_${MODULE_NAME}${VER_SUFFIX})" ];then
+					dbus set "softcenter_module_${MODULE_NAME}${VER_SUFFIX}=0.1"
 					echo_date "插件安装脚本里没有找到版本号，设置默认版本号为0.1"
 				else
-					echo_date "插件安装脚本已经设置了插件版本号为：`dbus get softcenter_module_$MODULE_NAME$VER_SUFFIX`"
+					echo_date "插件安装脚本已经设置了插件版本号为：$(dbus get softcenter_module_${MODULE_NAME}${VER_SUFFIX})"
 				fi
 			fi
-			install_pid=`ps | grep -w install.sh | grep -v grep | awk '{print $1}'`
+			install_pid=$(ps | grep -w install.sh | grep -v grep | awk '{print $1}')
 			i=120
 			until [ -z "$install_pid" ]
 			do
-				install_pid=`ps | grep -w install.sh | grep -v grep | awk '{print $1}'`
+				install_pid=$(ps | grep -w install.sh | grep -v grep | awk '{print $1}')
 				i=$(($i-1))
 				if [ "$i" -lt 1 ];then
 					echo_date "Could not load nat rules!"
@@ -121,7 +167,7 @@ install_tar(){
 					echo_date 删除相关文件并退出...
 					sleep 1
 					clean
-					dbus remove "softcenter_module_$MODULE_NAME$INSTALL_SUFFIX"
+					dbus remove "softcenter_module_${MODULE_NAME}${INSTALL_SUFFIX}"
 					echo_date ======================== end ============================
 					echo XU6J03M6
 					exit
@@ -130,6 +176,20 @@ install_tar(){
 			done
 			echo_date 离线包安装完成！
 			echo_date 一点点清理工作...
+
+			# 安装完毕，打印剩余空间
+			local JFFS_AVAL_2=$(jffs_space)
+			local JFFS_USED=$(($JFFS_AVAL - $JFFS_AVAL_2))
+			if [ "${JFFS_USED}" -ge "0" ];then
+				echo_date "软件中心：本次安装占用了${JFFS_USED}KB空间，目前jffs分区剩余容量：${JFFS_AVAL_2}KB"
+			elif [ "${JFFS_USED}" -lt "0" ];then
+				local JFFS_RELEASED=${JFFS_USED#-}
+				echo_date "软件中心：本次安装释放了${JFFS_RELEASED}KB空间，目前jffs分区剩余容量：${JFFS_AVAL_2}KB"
+			fi
+			if [ "${JFFS_AVAL_2}" -lt "2000" ];then
+				echo_date "软件中心：注意！目前jffs分区剩余容量只剩下：${JFFS_AVAL_2}KB，已不足2MB！"
+			fi
+
 			clean
 			echo_date 完成！离线安装插件成功，现在你可以退出本页面~
 		else
@@ -147,7 +207,23 @@ install_tar(){
 	echo XU6J03M6
 }
 
-echo " " > /tmp/upload/soft_log.txt
+clean_backup_log() {
+	local LOG_MAX=1000
+	[ $(wc -l "$LOG_FILE_BACKUP" | awk '{print $1}') -le "$LOG_MAX" ] && return
+	local logdata=$(tail -n 500 "$LOG_FILE_BACKUP")
+	echo "$logdata" > $LOG_FILE_BACKUP 2> /dev/null
+	unset logdata
+}
+
+backup_log_file(){
+	sleep 3
+	clean_backup_log
+	echo XU6J03M6 | tee -a $LOG_FILE
+	cat $LOG_FILE >> $LOG_FILE_BACKUP
+}
+
+true > $LOG_FILE
 http_response "$1"
-install_tar > /tmp/upload/soft_log.txt
+install_tar | tee -a $LOG_FILE
+backup_log_file
 
diff --git a/release/src/router/softcenter/softcenter/webs/Module_Softcenter.asp b/release/src/router/softcenter/softcenter/webs/Module_Softcenter.asp
old mode 100644
new mode 100755
index 0eb7c27868..254cdcf023
--- a/release/src/router/softcenter/softcenter/webs/Module_Softcenter.asp
+++ b/release/src/router/softcenter/softcenter/webs/Module_Softcenter.asp
@@ -7,7 +7,7 @@
 <meta HTTP-EQUIV="Expires" CONTENT="-1">
 <link rel="shortcut icon" href="images/favicon.png">
 <link rel="icon" href="images/favicon.png">
-<title>Merlin software center</title>
+<title>KoolShare - 软件中心</title>
 <link rel="stylesheet" type="text/css" href="index_style.css">
 <link rel="stylesheet" type="text/css" href="form_style.css">
 <link rel="stylesheet" type="text/css" href="/res/softcenter.css">
@@ -219,11 +219,72 @@ input[type=button]:focus {
 	margin-top:9px;
 	margin-bottom:9x;
 }
+.content_status {
+	position: absolute;
+	-webkit-border-radius: 5px;
+	-moz-border-radius: 5px;
+	border-radius:10px;
+	z-index: 100;
+	/*background-color:#2B373B;*/
+	/*margin-left: -215px;*/
+	top: 0px;
+	width:980px;
+	return height:auto;
+	box-shadow: 3px 3px 10px #000;
+	background: rgba(0,0,0,0.90);
+	visibility:hidden;
+	margin-left:0px;
+	width:728px;
+}
+.popup_bar_bg_ks{
+	position:fixed;	
+	margin: auto;
+	top: 0;
+	left: 0;
+	width:100%;
+	height:100%;
+	z-index:99;
+	/*background-color: #444F53;*/
+	filter:alpha(opacity=90);  /*IE5、IE5.5、IE6、IE7*/
+	background-repeat: repeat;
+	visibility:hidden;
+	overflow:hidden;
+	/*background: url(/images/New_ui/login_bg.png);*/
+	background:rgba(68, 79, 83, 0.94) none repeat scroll 0 0 !important;
+	background-position: 0 0;
+	background-size: cover;
+	opacity: .94;
+}
+.user_title{
+	text-align:center;
+	font-size:18px;
+	color:#99FF00;
+	padding:10px;
+	font-weight:bold;
+}
+#log_content{
+	width: 98%;
+	padding-left: 13px;
+	padding-right: 33px;
+	border: 0px solid #222;
+	font-family:'Lucida Console';
+	font-size: 11px;
+	background: transparent;
+	color: #FFFFFF;
+	outline: none;
+	overflow-x: hidden;
+}
+#softcenter_log_title i{
+	color: #FC0;
+	font-style: normal;
+}
 </style>
 <script>
 var db_softcenter_ = {};
 var TIMEOUT_SECONDS = 18;
 var softInfo = null;
+var count_down;
+var	refresh_flag;
 var syncRemoteSuccess = 0; //判断是否进入页面后已经成功进行远端同步
 var currState = {
 	"installing": false,
@@ -231,24 +292,23 @@ var currState = {
 	"lastStatus": "-1",
 	"module": ""
 };
+
+String.prototype.myReplace = function(f, e){
+    var reg = new RegExp(f, "g"); 
+    return this.replace(reg, e); 
+}
+
 function checkField(o, f, d) {
 	if (typeof o[f] == "undefined") {
 		o[f] = d;
 	}
-
 	return o[f];
 }
 function appPostScript(moduleInfo, script) {
-	if (currState.installing) {
-		console.log("current is in installing state");
-		return;
-	}
-	//Current page must has prefix of "Module_"
 	var data = {};
-	//currState.name = moduleInfo.name;
-	//TODO auto choose for home_url
 	data["softcenter_home_url"] = "https://armsoft.ddnsto.com";
 	data["softcenter_installing_todo"] = moduleInfo.name;
+	data["softcenter_installing_title"] = moduleInfo.title;
 	if (script == "ks_app_install.sh") {
 		data["softcenter_installing_tar_url"] = moduleInfo.tar_url;
 		data["softcenter_installing_md5"] = moduleInfo.md5;
@@ -272,14 +332,9 @@ function appPostScript(moduleInfo, script) {
 		data: JSON.stringify(postData),
 		dataType: "json",
 		success: function(response) {
-			var d = new Date();
-			//持续更新
-			currState.lastChangeTick = d / 1000 + TIMEOUT_SECONDS;
-			currState.installing = true;
-			showInstallStatus(true);
-		},
-		error: function() {
-			currState.installing = false;
+			count_down = 5;
+			refresh_flag = 1;
+			get_log();
 		}
 	});
 }
@@ -292,86 +347,25 @@ function appUninstallModule(moduleInfo) {
 	}
 	appPostScript(moduleInfo, "ks_app_remove.sh");
 }
-function initInstallStatus() {
-	var o = db_softcenter_;
-	var base = "softcenter_installing_";
-	if (o[base + "status"]) {
-		//状态不是0/1/7,则当前正处于安装状态,实时更新安装信息
-		if ((o[base + "status"] != "0") && (o[base + "status"] != "1") && (o[base + "status"] != "7")) {
-			var d = new Date();
-			currState.lastChangeTick = d / 1000 + TIMEOUT_SECONDS;
-			currState.lastStatus = o[base + "status"];
-			currState.installing = true;
-			//currState.name = o[base+"module"];
-			showInstallStatus(true);
-		}
-	}
-}
-function showInstallStatus(isInit) {
+
+function initInstallStatus(){
+	console.log("sadog!");
 	$.ajax({
-		type: "GET",
-		url: "/_api/softcenter_installing_",
-		dataType: "json",
-		async: false,
-		success: function(resp) {
-			var o = resp.result[0];
-			var base = "softcenter_installing_";
-			console.log("status: " + o[base + "status"]);
-			if (isInit) {
-				currState.lastStatus = o[base + "status"];
-			}
-			var d = new Date();
-			var curr = d.getTime() / 1000;
-			curr_module = checkField(o, "softcenter_installing_module", "");
-			if (o[base + "status"] != currState.lastStatus) {
-				currState.lastStatus = o[base + "status"];
-				showInstallInfo(curr_module, currState.lastStatus);
-				// Install ok now
-				if (currState.lastStatus == "1" || currState.lastStatus == "7" || currState.lastStatus == "13") {
-					currState.installing = false;
-					setTimeout("window.location.reload()", 1000);
-					return;
-				} else if (currState.lastStatus == "0") {
-					currState.installing = false;
-				}
-			}
-			if (currState.lastChangeTick > curr) {
-				setTimeout("showInstallStatus()", 400);
-			} else {
-				currState.installing = false;
-				$("#appInstallInfo").html("等待超时,可尝试手动刷新");
-				//showInstallInfo("", currState.lastStatus);
+		url: '/_temp/soft_install_log.txt',
+		type: 'GET',
+		cache: false,
+		dataType: 'text',
+		success: function(response) {
+			//获取一次日志，如果日志存在，且没有"XU6J03M6"字符串，则说明有插件正在安装，那么弹出日志显示页面
+			if (response.search("XU6J03M6") == -1) {
+				count_down = 5;
+				refresh_flag = 1;
+				get_log();
 			}
 		}
-	})
-}
-function showInstallInfo(module, scode) {
-		var code = parseInt(scode);
-		var s = module.capitalizeFirstLetter();
-		var infos = [
-			"操作失败",
-			"已安装",
-			"插件将被安装到jffs分区...",
-			"正在下载中...请耐心等待...",
-			"正在安装中...",
-			"安装成功！请5秒后刷新本页面！...",
-			"卸载中......",
-			"卸载成功！",
-			"没有检测到在线版本号！",
-			"正在下载更新......",
-			"正在安装更新...",
-			"安装更新成功，5秒后刷新本页！ ",
-			"下载文件校验不一致！",
-			"然而并没有更新！",
-			"正在检查是否有更新~",
-			"检测更新错误！",
-			" wget下载错误，详情见系统日志！",
-			"卸载失败！请关闭插件后重试！"
-		];
-		document.getElementById("install_status").style.display = "";
-		$("#appInstallInfo").html(s + infos[code]);
-	}
-	//切换安装未安装面板
+	});
+}
+
 function toggleAppPanel(showInstall) {
 		$('.show-install-btn').removeClass('active');
 		$('.show-uninstall-btn').removeClass('active');
@@ -453,6 +447,7 @@ function softceterInitData(data) {
 		$("#updateBtn").click(function() {
 			var moduleInfo = {
 				"name": "softcenter",
+				"title": "软件中心",
 				"md5": remoteData.md5,
 				"tar_url": remoteData.tar_url,
 				"version": remoteData.version
@@ -496,6 +491,8 @@ function init(cb) {
 				return result;
 			}
 		//将本地和远程进行一次对比合并
+		var usb_apps = ["aria2", "swap", "usb2jffs", "easyexplorer", "linkease"];
+		var ro_model = '<% nvram_get("odmpid"); %>' || '<% nvram_get("productid"); %>';
 		function _mergeData(remoteData) {
 			var result = {};
 			var localData = _formatLocalData(db_softcenter_);
@@ -503,8 +500,16 @@ function init(cb) {
 				var name = app.name;
 				var oldApp = localData[name] || {};
 				var install = (parseInt(oldApp.install, 10) === 1 && app.version !== oldApp.version) ? 2 : oldApp.install || "0";
-				result[name] = $.extend(oldApp, app);
-				result[name].install = install;
+				if(ro_model == "ZenWiFi_XD4" || ro_model == "RT-AX56U_V2"){
+					var usb_app = usb_apps.includes(name);
+					if(usb_app == false){
+						result[name] = $.extend(oldApp, app);
+						result[name].install = install;
+					}
+				}else{
+					result[name] = $.extend(oldApp, app);
+					result[name].install = install;
+				}
 			});
 			$.map(localData, function(app, name) {
 				if (!result[name]) {
@@ -573,43 +578,80 @@ $(function() {
 				db_softcenter_["softcenter_version"] = "0.0";
 			}
 			$("#spnCurrVersion").html("<em>" + db_softcenter_["softcenter_version"] + "</em>");
-			var jff2_scripts="<% nvram_get("jffs2_scripts"); %>";
-			if(jff2_scripts != 1){
-				$('#software_center_message').html('<h2><font color="#FF9900">错误！</font></h2><h2>软件中心不可用！因为你没有开启Enable JFFS custom scripts and configs选项！</h2><h2>请前往【系统管理】-<a href="Advanced_System_Content.asp"><u><em>【系统设置】</em></u></a>开启此选项再使用软件中心！！</h2>')
+			var EXT = '<% nvram_get("extendno"); %>';
+			if (EXT.indexOf('koolshare') != -1){
+				console.log("正在使用koolshare官改固件！");
 			}else{
+				console.log("正在使用koolshare梅林改版固件！");
+				var jff2_scripts="<% nvram_get("jffs2_scripts"); %>";
+				if(jff2_scripts != 1){
+					$('#software_center_message').html('<h1><font color="#FF9900">错误！</font></h1><h2>软件中心不可用！</h2><h2>因为你没有开启Enable JFFS custom scripts and configs选项！</h2><h2>请前往【系统管理】-<a href="Advanced_System_Content.asp"><u><em>【系统设置】</em></u></a>开启此选项再使用软件中心！</h2><h2>如果你是官改固件，请尝试重置路由器以重新初始化软件中心！</h2><h2>需要更多帮助，请前往<a href="https://koolshare.cn"><em><u>https://koolshare.cn</u></em></a>koolshare论坛交流反馈</h2>')
+					return false;
+				}
+			}
+			initInstallStatus();
+			init(function() {
+				toggleAppPanel(1);
+				//一刷新界面是否就正在插件在安装.
+			});
+			//挂接tab切换安装状态事件
+			$('.show-install-btn').click(function() {
 				init(function() {
 					toggleAppPanel(1);
-					//一刷新界面是否就正在插件在安装.
-					initInstallStatus();
 				});
-				//挂接tab切换安装状态事件
-				$('.show-install-btn').click(function() {
-					init(function() {
-						toggleAppPanel(1);
-					});
+			});
+			$('.show-uninstall-btn').click(function() {
+				init(function() {
+					toggleAppPanel(0);
 				});
-				$('.show-uninstall-btn').click(function() {
-					init(function() {
-						toggleAppPanel(0);
-					});
+			});
+			//挂接安装或者卸载事件
+			$('#IconContainer').on('click', '.install-btn', function() {
+				var name = $(this).data('name');
+				console.log('install', name);
+				appInstallModule(softInfo[name]);
+			});
+			$('#IconContainer').on('click', '.uninstall-btn', function() {
+				var name = $(this).data('name');
+				console.log('uninstall', name);
+				appUninstallModule(softInfo[name]);
+			});
+			$('#IconContainer').on('click', '.update-btn', function() {
+				var name = $(this).data('name');
+				console.log('update', name);
+				appInstallModule(softInfo[name]);
+			});
+			//保留日志显示窗口
+			$(".popup_bar_bg_ks").click(
+				function() {
+					count_down = -1;
 				});
-				//挂接安装或者卸载事件
-				$('#IconContainer').on('click', '.install-btn', function() {
-					var name = $(this).data('name');
-					console.log('install', name);
-					appInstallModule(softInfo[name]);
+			//窗口大小调整
+			$(window).resize(function(){
+				if($('.content_status').css("visibility") == "visible"){
+					document.scrollingElement.scrollTop = 0;
+					var page_h = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
+					var page_w = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
+					var log_h = E("softcenter_log_pannel").clientHeight;
+					var log_w = E("softcenter_log_pannel").clientWidth;
+					var log_h_offset = (page_h - log_h) / 2;
+					var log_w_offset = (page_w - log_w) / 2 + 90;
+					$('#softcenter_log_pannel').offset({top: log_h_offset, left: log_w_offset});
+				}
+			});
+			//挂接按钮功能
+			$("#clean_log").click(
+				function() {
+					manipulate_softcenter_log("clean_log");
 				});
-				$('#IconContainer').on('click', '.uninstall-btn', function() {
-					var name = $(this).data('name');
-					console.log('uninstall', name);
-					appUninstallModule(softInfo[name]);
+			$("#download_log").click(
+				function() {
+					manipulate_softcenter_log("download_log");
 				});
-				$('#IconContainer').on('click', '.update-btn', function() {
-					var name = $(this).data('name');
-					console.log('update', name);
-					appInstallModule(softInfo[name]);
+			$("#close_log").click(
+				function() {
+					close_softcenter_log();
 				});
-			}
 		}
 	});
 });
@@ -626,25 +668,205 @@ function notice_show() {
 			$("#push_titile").html(res.title);
 			$("#push_content1").html(res.content1);
 			if (res.content2) {
-				document.getElementById("push_content2_li").style.display = "";
+				E("push_content2_li").style.display = "";
 				$("#push_content2").html(res.content2);
 			}
 			if (res.content3) {
-				document.getElementById("push_content3_li").style.display = "";
+				E("push_content3_li").style.display = "";
 				$("#push_content3").html(res.content3);
 			}
 			if (res.content4) {
-				document.getElementById("push_content4_li").style.display = "";
+				E("push_content4_li").style.display = "";
 				$("#push_content4").html(res.content4);
 			}
 		}
 	});
 }
+function count_down_close() {
+	if (count_down == "0") {
+		close_softcenter_log();
+	}
+	if (count_down < 0) {
+		E("close_log").value = "关闭日志"
+		return false;
+	}
+	E("close_log").value = "自动关闭（" + count_down + "）"
+		--count_down;
+	setTimeout("count_down_close();", 1000);
+}
+function close_softcenter_log() {
+	E("softcenter_shade_pannel").style.visibility = "hidden";
+	E("softcenter_log_pannel").style.visibility = "hidden";
+	E("download_log").style.visibility = "hidden";
+	E("close_log").style.visibility = "hidden";
+	E("clean_log").style.visibility = "hidden";
+	if (refresh_flag == "1"){
+		refreshpage();
+	}
+	$(".show-install-btn").trigger("click");
+}
+function get_log(flag) {
+	if (flag){
+		E("download_log").style.visibility = "visible";
+		E("close_log").style.visibility = "visible";
+		E("clean_log").style.visibility = "visible";
+		E("log_content").rows = "32";
+		var LOG_FILE = '/_temp/soft_install_log_backup.txt';
+	}else{
+		E("download_log").style.visibility = "hidden";
+		E("close_log").style.visibility = "hidden";
+		E("clean_log").style.visibility = "hidden";
+		E("log_content").rows = "26";
+		var LOG_FILE = '/_temp/soft_install_log.txt';
+	}
+	document.scrollingElement.scrollTop = 0;
+	var page_h = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
+	var page_w = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
+	var log_h = E("softcenter_log_pannel").clientHeight;
+	var log_w = E("softcenter_log_pannel").clientWidth;
+	var log_h_offset = (page_h - log_h) / 2;
+	var log_w_offset = (page_w - log_w) / 2 + 90;
+	$('#softcenter_log_pannel').offset({top: log_h_offset, left: log_w_offset});
+
+	E("softcenter_shade_pannel").style.visibility = "visible";
+	E("softcenter_log_pannel").style.visibility = "visible";
+	
+	$.ajax({
+		url: LOG_FILE,
+		type: 'GET',
+		dataType: 'html',
+		async: false,
+		cache: false,
+		success: function(response) {
+			if (flag){
+				E("softcenter_log_title").innerHTML = "<i>&nbsp;&nbsp;&nbsp;&nbsp;软件中心插件安装/卸载日志记录。</i>";
+			}else{
+				E("softcenter_log_title").innerHTML = "<i>&nbsp;&nbsp;&nbsp;&nbsp;插件安装/卸载过程中请勿刷新此页面！</i>";
+			}
+			if (response.search("XU6J03M6") != -1) {
+				E("log_content").value = response.myReplace("XU6J03M6", " ");
+				E("log_content").scrollTop = E("log_content").scrollHeight;
+				E("close_log").style.visibility = "visible";
+				if (flag){
+					count_down = -1;
+				}else{
+					count_down = 5;
+				}
+				count_down_close();
+				return true;
+			}
+			setTimeout("get_log(" + flag + ");", 300);
+			E("log_content").value = response.myReplace("XU6J03M6", " ");
+			E("log_content").scrollTop = E("log_content").scrollHeight;
+		},
+		error: function(xhr) {
+			E("softcenter_log_title").innerHTML = "<i>&nbsp;&nbsp;&nbsp;&nbsp;暂无软件中心日志信息</i>";
+			E("log_content").value = "日志文件为空，请关闭本窗口！";
+			E("close_log").style.visibility = "visible";
+			return false;
+		}
+	});
+}
+function manipulate_softcenter_log(arg) {
+	var id = parseInt(Math.random() * 100000000);
+	var postData = {"id": id, "method": "ks_app_install.sh", "params":[arg], "fields": "" };
+	$.ajax({
+		type: "POST",
+		url: "/_api/",
+		async: false,
+		cache: false,
+		data: JSON.stringify(postData),
+		dataType: "json",
+		success: function(response){
+			if(response.result == id){
+				if(arg == "download_log"){
+					var b = document.createElement('A')
+					b.href = "_root/files/softcenter_log.txt"
+					b.download = 'softcenter_log.txt'
+					document.body.appendChild(b);
+					b.click();
+					document.body.removeChild(b);
+				}
+				if(arg == "clean_log"){
+					E("log_content").value = "日志已清除，请关闭本窗口！"
+				}
+			}
+		},
+		error: function(xhr) {
+			alert("日志下载失败！");
+			return false;
+		}
+	});
+}
+function ks_online() {
+	require(['/res/layer/layer.js'], function(layer) {
+		layer.open({
+			type: 1,
+			title: false,
+			closeBtn: false,
+			area: '860px;',
+			shade: 0.8,
+			shadeClose: 0,
+			scrollbar: false,
+			id: 'LAY_layuipro',
+			btn: ['关闭窗口', '参加【Ks Online】计划'],
+			btnAlign: 'c',
+			moveType: 1,
+			content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">\
+				<b>软件中心【Ks Online】计划</b><br><br>\
+				<p>\
+				向大家介绍一下我们最近做的一个项目，叫：Ks Online<br>\
+				<br>\
+				参加Ks Online计划后，会有一个叫ks_online.sh的脚本发送你路由器的型号，固件版本等信息到一个在线的数据库服务器。<br>\
+				ks_online.sh脚本提交到服务器的信息是100%匿名的，并且只会被用于数据统计用途。<br>\
+				<b>ks_online.sh脚本在任何情况下都不会搜集或发送你的隐私或者个人数据（比如：MAC地址，IP地址等信息）!</b><br>\
+				ks_online.sh脚本是完全开放的，并且是纯shell脚本，其安装在固件的/koolshare/scripts目录下，所有人都可以自由的查看自己路由器中该脚本将要搜集和发送到数据库的信息。<br>\
+				<\p>\
+				<br>\
+				<p>\
+				ks_online.sh脚本搜集的数据可以在此<a style="color:#e7bd16" target="_blank" href="https://ksonline.ddnsto.com"><u>Ks Online 统计页面</u></a>查看到。<br>\
+				该信息可以在一定程度上帮助你选择最佳的路由器版本，或者帮助需要购买路由器的朋友了解到当前最流行的型号。<br>\
+				因为你可以直观的看到使用人数最多的固件版本、路由器型号，也可以根据开机时间、路由器温度等信息找到你认为稳定的型号。<br>\
+				如果你对上传并共享你的路由器相关信息感到不满，你可以随时在此页面关闭【Ks Online】功能。<br>\
+				当然你也可以在任何时候重新开启【Ks Online】。<br>\
+				<\p>\
+				<br>\
+				<p>\
+				以下是ks_online.sh脚本将会搜集并发送的全部信息：<br>\
+				<\p>\
+				<ul>\
+				<li>LAN MAC地址的md5校验值 - 用以提供路由器的唯一识别码, 例如: fab3201b83137711623c97504bd8b51c</li>\
+				<li>路由器型号, 例如: RT-AX86U</li>\
+				<li>固件版本号, 例如: 384_9262_koolshare</li>\
+				<li>国家或地区, 例如: 上海市</li>\
+				<li>路由开机时间, 例如: 3天</li>\
+				<li>路由CPU温度, 例如: 69℃</li>\
+				</ul>\
+				对【Ks Online】计划有任何建议或者问题，可以前往<a style="color:#e7bd16" target="_blank" href="https://ksonline.ddnsto.com"><u>【Ks Online】计划讨论贴</u></a>反馈~<br><br>\
+				我们的征途是星辰大海 ^_^</div>'
+		});
+	});
+}
 </script>
 </head>
 <body>
 	<div id="TopBanner"></div>
 	<div id="Loading" class="popup_bg"></div>
+	<div id="softcenter_shade_pannel" class="popup_bar_bg_ks">
+		<!-- this is the popup area for install/uninstall log status -->
+		<div id="softcenter_log_pannel" class="content_status">
+			<div class="user_title">软件中心 - 日志记录</div>
+			<div style="margin-left:15px" id="softcenter_log_title"></div>
+			<div style="margin: 10px 10px 10px 10px;width:98%;text-align:center;overflow:hidden;">
+				<textarea cols="63" rows="25" wrap="on" readonly="readonly" id="log_content" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
+			</div>
+			<div style="margin-top:5px;padding-bottom:10px;width:100%;text-align:center;">
+				<input class="button_gen" type="button" style="visibility:hidden;min-width:88px;" id="download_log" value="下载日志">
+				<input class="button_gen" type="button" style="visibility:hidden;min-width:88px;margin-left: 10px;" id="close_log" value="关闭日志">
+				<input class="button_gen" type="button" style="visibility:hidden;min-width:88px;margin-left: 10px;" id="clean_log" value="清空日志">
+			</div>
+		</div>
+	</div>
 	<table class="content" align="center" cellpadding="0" cellspacing="0">
 		<tr>
 			<td width="17">&nbsp;</td>
@@ -660,17 +882,21 @@ function notice_show() {
 								<div>
 									<table width="760px" border="0" cellpadding="5" cellspacing="0" bordercolor="#6b8fa3" class="FormTitle" id="FormTitle">
 										<tr>
-											<td bgcolor="#4D595D" colspan="3" valign="top">
+											<td id="main_td" bgcolor="#4D595D" colspan="3" valign="top">
 												<div>&nbsp;</div>
-												<div id="title_name" class="formfonttitle"></div>
+												<div id="title_name" class="formfonttitle" style="float: left;"></div>
 												<script type="text/javascript">
-													var MODEL = '<% nvram_get("odmpid"); %>' || '<% nvram_get("model"); %>';
+													var MODEL = '<% nvram_get("odmpid"); %>' || '<% nvram_get("productid"); %>';
 													$("#title_name").html("Software Center " + MODEL)
 												</script>
+												<div align="right" style="padding-right:10px;">
+													<a type="button" class="ks_btn" href="javascript:void(0);" onclick="get_log(1)">查看日志</a>
+													<!--<a type="button" class="ks_btn" style="margin-left: 5px;" href="javascript:void(0);" onclick="ks_online()">ks online</a>-->
+												</div>
 												<div style="margin:10px 0 10px 5px;" class="splitLine"></div>
-													<table width="100%" border="1" align="center" cellpadding="4" cellspacing="0" bordercolor="#6b8fa3" class="FormTable">
+													<table id="ks_info" width="100%" border="1" align="center" cellpadding="4" cellspacing="0" bordercolor="#6b8fa3" class="FormTable">
 													</table>
-													<table width="100%" height="150px" style="border-collapse:collapse;">
+													<table id="ks_pannel" width="100%" height="150px" style="border-collapse:collapse;">
 														<tr bgcolor="#444f53">
 															<td colspan="5" bgcolor="#444f53" class="cloud_main_radius">
 																<div style="width:95%;font-style:italic;font-size:14px;">
@@ -680,7 +906,7 @@ function notice_show() {
 																				<ul style="padding-left:25px;">
 																					<h2 id="push_titile"><em>软件中心&nbsp;-&nbsp;by&nbsp;koolshare</em></h2>
 																					<li>
-																						<h4 id="push_content1" ><font color='#1E90FF'>交流反馈:&nbsp;&nbsp;</font><a href='https://github.com/koolshare/rogsoft' target='_blank'><em>1.软件中心GitHub项目</em></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href='https://t.me/xbchat' target='_blank'><em>2.加入telegram群</em></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href='http://shang.qq.com/wpa/qunwpa?idkey=f475468129ba8019245425559b5df5bdad7d7201ac7780417dd0218bbb4e1322' target='_blank'><em>3.加入QQ群</em></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href='http://koolshare.cn/forum-98-1.html' target='_blank'><em>4.Koolshare论坛插件版块</em></a></h4>
+																						<h4 id="push_content1" ><font color='#1E90FF'>交流反馈:&nbsp;&nbsp;</font><a href='https://github.com/koolshare/armsoft' target='_blank'><em>1.软件中心GitHub项目</em></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href='https://t.me/xbchat' target='_blank'><em>2.加入telegram群</em></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href='http://shang.qq.com/wpa/qunwpa?idkey=f475468129ba8019245425559b5df5bdad7d7201ac7780417dd0218bbb4e1322' target='_blank'><em>3.加入QQ群</em></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href='http://koolshare.cn/forum-98-1.html' target='_blank'><em>4.Koolshare论坛插件版块</em></a></h4>
 																					</li>
 																					<li id="push_content2_li" style="display: none;">
 																						<h4 id="push_content2"></h4>
@@ -705,14 +931,6 @@ function notice_show() {
 														<tr height="10px">
 															<td colspan="3"></td>
 														</tr>
-														<tr bgcolor="#444f53" id="install_status" style="display: none;" width="235px">
-															<td>
-																<div style="padding:10px;width:95%;font-size:14px;" id="appInstallInfo">
-																</div>
-															</td>
-															<td class="cloud_main_radius_right">
-															</td>
-														 </tr>
 														<tr height="10px">
 															<td colspan="3"></td>
 														</tr>
@@ -731,9 +949,9 @@ function notice_show() {
 															<td colspan="3"></td>
 														</tr>
 													</table>
-												<div class="KoolshareBottom">
+												<div id="ks_logo" class="KoolshareBottom">
 													论坛技术支持: <a href="https://koolshare.cn" target="_blank"> <i><u>https://koolshare.cn</u></i></a><br />
-													GitHub: <a href="https://github.com/koolshare/rogsoft" target="_blank"><i><u>https://github.com/koolshare</u></i></a><br />
+													GitHub: <a href="https://github.com/koolshare/armsoft" target="_blank"><i><u>https://github.com/koolshare</u></i></a><br />
 													Shell & Web by: <a href="mailto:sadoneli@gmail.com"><i>sadoneli</i></a>, <i>Xiaobao</i>
 												</div>
 											</td>
diff --git a/release/src/router/softcenter/softcenter/webs/Module_Softsetting.asp b/release/src/router/softcenter/softcenter/webs/Module_Softsetting.asp
old mode 100644
new mode 100755
index c8b445a65d..909a858163
--- a/release/src/router/softcenter/softcenter/webs/Module_Softsetting.asp
+++ b/release/src/router/softcenter/softcenter/webs/Module_Softsetting.asp
@@ -20,9 +20,18 @@
 <script type="text/javascript" src="/switcherplugin/jquery.iphone-switch.js"></script>
 <script type="text/javascript" src="/res/softcenter.js"></script>
 <script language="JavaScript" type="text/javascript" src="/client_function.js"></script>
+<style>
+input[type=button]:focus {
+	outline: none;
+}
+</style>
 <script>
 var _responseLen;
 var noChange = 0;
+String.prototype.myReplace = function(f, e){
+	var reg = new RegExp(f, "g"); 
+	return this.replace(reg, e); 
+}
 function init(menu_hook) {
 	show_menu();
 	get_log();
@@ -84,7 +93,7 @@ function install_now(moduleInfo) {
 	});
 }
 function get_log(s) {
-	var retArea = E("soft_log");
+	var retArea = E("soft_log_area");
 	$.ajax({
 		url: '/_temp/soft_log.txt',
 		type: 'GET',
@@ -92,7 +101,7 @@ function get_log(s) {
 		cache: false,
 		success: function(response) {
 			if (response.search("XU6J03M6") != -1) {
-				retArea.value = response.replace("XU6J03M6", " ");
+				retArea.value = response.myReplace("XU6J03M6", " ");
 				retArea.scrollTop = retArea.scrollHeight;
 				if (s) {
 					setTimeout("window.location.reload()", 3000);
@@ -116,7 +125,7 @@ function get_log(s) {
 		},
 		error: function(xhr, status, error) {
 			if (s) {
-				E("soft_log").value = "获取日志失败！";
+				E("soft_log_area").value = "获取日志失败！";
 			}
 		}
 	});
@@ -167,8 +176,8 @@ function get_log(s) {
 												</td>
 											</tr>
 										</table>
-										<div id="log_content" style="margin-top:10px;display: block;">
-											<textarea cols="63" rows="40" wrap="off" readonly="readonly" id="soft_log" style="width:99%; font-family:'Lucida Console'; font-size:12px;background:#475A5F;color:#FFFFFF;"></textarea>
+										<div id="log_content" class="soft_setting_log">
+											<textarea cols="63" rows="40" wrap="on" readonly="readonly" id="soft_log_area" class="soft_setting_log1" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
 										</div>
 										<div class="KoolshareBottom">
 											论坛技术支持: <a href="https://koolshare.cn" target="_blank"> <i><u>https://koolshare.cn</u></i></a><br />
-- 
2.25.1

