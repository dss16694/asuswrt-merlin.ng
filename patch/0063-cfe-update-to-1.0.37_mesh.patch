From d7946181612c455c8886d0bbd63e8606712057a4 Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Wed, 15 Jul 2020 01:47:35 +0800
Subject: [PATCH 063/122] cfe: update to 1.0.37_mesh rc: generate PIN code and
 change 2.4G MAC for AiMesh.

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 .../bcm947xx/compressed/rt-k3_nvram.txt       | 67 ++++++++++---------
 release/src/router/rc/k3.c                    | 61 ++++++++++++++---
 2 files changed, 88 insertions(+), 40 deletions(-)

diff --git a/release/src-rt-7.14.114.x/src/cfe/build/broadcom/bcm947xx/compressed/rt-k3_nvram.txt b/release/src-rt-7.14.114.x/src/cfe/build/broadcom/bcm947xx/compressed/rt-k3_nvram.txt
index 475236aa67..cdea9f828e 100644
--- a/release/src-rt-7.14.114.x/src/cfe/build/broadcom/bcm947xx/compressed/rt-k3_nvram.txt
+++ b/release/src-rt-7.14.114.x/src/cfe/build/broadcom/bcm947xx/compressed/rt-k3_nvram.txt
@@ -405,7 +405,7 @@ devpath1=pcie/1/1/
 1:venid=0x14e4
 1:devid=0x43c4
 1:macaddr=00:11:22:33:44:66
-1:ccode=ALL
+1:ccode=#a
 1:regrev=0
 1:aa2g=15
 1:agbg0=0x133
@@ -466,7 +466,7 @@ devpath1=pcie/1/1/
 1:rxgainerr2ga0=63
 1:rxgainerr2ga1=31
 1:rxgainerr2ga2=31
-1:rpcal2g=0
+1:rpcal2g=0XFA1A
 1:txidxcap2g=0
 1:pdoffsetcckma0=15
 1:pdoffsetcckma1=15
@@ -509,10 +509,10 @@ devpath1=pcie/1/1/
 1:swctrlmap4_RX2g_fem7to4=0
 1:swctrlmap4_RXByp2g_fem7to4=0
 1:swctrlmap4_misc2g_fem7to4=0
-1:maxp2ga0=0x72
-1:maxp2ga1=0x72
-1:maxp2ga2=0x72
-1:maxp2ga3=0x72
+1:maxp2ga0=0x78
+1:maxp2ga1=0x78
+1:maxp2ga2=0x78
+1:maxp2ga3=0x78
 1:pa2ga0=0x1D05,0xD4C7,0x1E54,0x2407
 1:pa2ga1=0x1CE3,0xD4E9,0x1E27,0x2409
 1:pa2ga2=0x1C71,0xD5A8,0x1D21,0x23DC
@@ -546,7 +546,7 @@ devpath2=pcie/2/1/
 2:venid=0x14e4
 2:devid=0x43c5
 2:macaddr=00:11:22:33:44:77
-2:ccode=ALL
+2:ccode=#a
 2:regrev=0
 2:aa5g=15
 2:aga0=71
@@ -621,10 +621,10 @@ devpath2=pcie/2/1/
 2:rxgainerr5ga1=31,31,31,31
 2:rxgainerr5ga2=31,31,31,31
 2:rxgainerr5ga3=31,31,31,31
-2:rpcal5gb0=0
-2:rpcal5gb1=0
-2:rpcal5gb2=0
-2:rpcal5gb3=0
+2:rpcal5gb0=0X6343
+2:rpcal5gb1=0X7043
+2:rpcal5gb2=0X7748
+2:rpcal5gb3=0X8257
 2:rpcal5gb4=0
 2:txidxcap5g=0
 2:pdoffsetcckma0=15
@@ -753,26 +753,26 @@ devpath2=pcie/2/1/
 2:rxchain=0xf
 2:txchain=0xf
 2:srom13sig=0x4D55
-2:maxp5gb0a0=0x72
-2:maxp5gb1a0=0x72
-2:maxp5gb2a0=0x72
-2:maxp5gb3a0=0x72
-2:maxp5gb4a0=0x72
-2:maxp5gb0a1=0x72
-2:maxp5gb1a1=0x72
-2:maxp5gb2a1=0x72
-2:maxp5gb3a1=0x72
-2:maxp5gb4a1=0x72
-2:maxp5gb0a2=0x72
-2:maxp5gb1a2=0x72
-2:maxp5gb2a2=0x72
-2:maxp5gb3a2=0x72
-2:maxp5gb4a2=0x72
-2:maxp5gb0a3=0x72
-2:maxp5gb1a3=0x72
-2:maxp5gb2a3=0x72
-2:maxp5gb3a3=0x72
-2:maxp5gb4a3=0x72
+2:maxp5gb0a0=0x78
+2:maxp5gb1a0=0x78
+2:maxp5gb2a0=0x78
+2:maxp5gb3a0=0x78
+2:maxp5gb4a0=0x78
+2:maxp5gb0a1=0x78
+2:maxp5gb1a1=0x78
+2:maxp5gb2a1=0x78
+2:maxp5gb3a1=0x78
+2:maxp5gb4a1=0x78
+2:maxp5gb0a2=0x78
+2:maxp5gb1a2=0x78
+2:maxp5gb2a2=0x78
+2:maxp5gb3a2=0x78
+2:maxp5gb4a2=0x78
+2:maxp5gb0a3=0x78
+2:maxp5gb1a3=0x78
+2:maxp5gb2a3=0x78
+2:maxp5gb3a3=0x78
+2:maxp5gb4a3=0x78
 2:pa5g80a0=0x1fef,0xd66f,0x3a19,0x257b,0x2078,0xd598,0x3bc7,0x2598,0x1F6E,0xD912,0x3B2A,0x2563,0x1FA2,0xD71C,0x38D3,0x2524,0x1fd2,0xd7e4,0x42ab,0x2637
 2:pa5g80a1=0x1ed5,0xe3ac,0x56d4,0x27c7,0x1e7e,0xeaa7,0x62ff,0x2842,0x1ED4,0xDCF0,0x44D1,0x25F4,0x1ECA,0xDED1,0x4896,0x266E,0x1f1c,0xd90b,0x41f2,0x2620
 2:pa5g80a2=0x1ecb,0xe726,0x5734,0x2793,0x1fe3,0xd902,0x3d54,0x25a6,0x1DE2,0xE5E7,0x5F8C,0x28A1,0x1E82,0xDD7E,0x5587,0x286B,0x1f57,0xd90b,0x3f66,0x25f2
@@ -789,6 +789,9 @@ devpath2=pcie/2/1/
 # for NAND flash
 bootflags=1
 
+# WPS AP PIN code
+secret_code=12345670
+
 # ODM Product ID
 odmpid=RT-AC3100
 
@@ -796,7 +799,7 @@ odmpid=RT-AC3100
 model=RT-AC3100
 
 # Bootloader Version
-bl_version=1.0.37
+bl_version=1.0.37_mesh
 
 # ATEMODE
 ATEMODE=0
diff --git a/release/src/router/rc/k3.c b/release/src/router/rc/k3.c
index fbbab78789..4b42555b46 100644
--- a/release/src/router/rc/k3.c
+++ b/release/src/router/rc/k3.c
@@ -59,17 +59,55 @@ void update_cfe_k3(void)
 {
 	char et0mac[18], wl1mac[18], wl2mac[18];
 	char buf[128];
+	char PIN[9];
+	int i, j, k = 0;
+	int val;
 
-	if (!check_if_file_exist(ROMCFE) || cfe_nvram_match("bl_version", "1.0.37"))
+	if (!check_if_file_exist(ROMCFE) || cfe_nvram_match("bl_version", "1.0.37_mesh"))
 		return;
 	//if (pids("envrams"))
-		//sleep(5);
+	//sleep(5);
 
 	strcpy(et0mac, cfe_nvram_safe_get("et0macaddr"));
 	strcpy(wl1mac, cfe_nvram_safe_get("1:macaddr"));
 	strcpy(wl2mac, cfe_nvram_safe_get("2:macaddr"));
-
-	if (pids("envrams")) {
+	for (i = 0; et0mac[i]; ++i) {
+		if (et0mac[i] == '-')
+			et0mac[i] = ':';
+	} // AiMesh only recognize 'XX:XX:XX:XX:XX:XX'
+	for (i = 0; wl1mac[i]; ++i) {
+		if (wl1mac[i] == '-')
+			wl1mac[i] = ':';
+	} // AiMesh only recognize 'XX:XX:XX:XX:XX:XX'
+	for (i = 0; wl2mac[i]; ++i) {
+		if (wl2mac[i] == '-')
+			wl2mac[i] = ':';
+	} // AiMesh only recognize 'XX:XX:XX:XX:XX:XX'
+
+	bzero(buf, sizeof(buf));
+	snprintf(buf, sizeof(buf), "%s", et0mac);
+	for (i = j = 0; buf[i]; ++i) {
+		if (buf[i] != ':')
+			buf[j++] = buf[i];
+	}
+	buf[j] = '\0';
+
+	/*
+		Generate PIN code with LAN MAC hex2dec
+	*/
+	val = strtoull(buf, 0, 16) % 10000000;
+	if (val < 1000000)
+		val += 1000000;
+	k += 3 * ((val / 1000000) + (val / 10000 % 10) + (val / 100 % 10) + (val / 1 % 10));
+	k += (val / 100000) + (val / 1000 % 10) + (val / 10 % 10);
+	k = 10 - (k % 10);
+	if (k == 10)
+		k = 0;
+	val = val * 10 + k;
+	snprintf(PIN, sizeof(PIN), "%d", val);
+
+	if (pids("envrams"))
+	{
 		killall_tk("envrams");
 		usleep(100000);
 	}
@@ -77,17 +115,24 @@ void update_cfe_k3(void)
 	doSystem("dd if=%s of=/dev/mtdblock0 2>/dev/null", ROMCFE);
 
 	envram_set("et0macaddr", et0mac);
-	envram_set("1:macaddr", wl1mac);
+	envram_set("1:macaddr", et0mac); // 2.4G MAC is the same as LAN MAC in Merlin
 	envram_set("2:macaddr", wl2mac);
+	if (cfe_nvram_safe_get("1:macbak") == "")
+		envram_set("1:macbak", wl1mac); // Backup 2.4G MAC
+	envram_set("secret_code", PIN);
 	envram_commit();
+	nvram_set("secret_code", PIN);
+	nvram_commit();
 
 	//if (pids("envrams"))
-		//killall_tk("envrams");
+	//killall_tk("envrams");
 
-	snprintf(buf, sizeof(buf), "Set CFE MAC: LAN=%s, 2.4G=%s, 5G=%s", et0mac, wl1mac, wl2mac);
-	//logmessage("K3INIT", "CFE has upgraded to 1.0.37 already!");
+	bzero(buf, sizeof(buf));
+	snprintf(buf, sizeof(buf), "Set CFE MAC: LAN & 2.4G=%s, 2.4G_bak=%s, 5G=%s", et0mac, wl1mac, wl2mac);
+	//logmessage("K3INIT", "CFE has upgraded to 1.0.37_mesh already!");
 	//logmessage("K3INIT", buf);
 	_dprintf("**** Upgraded CFE - %s\n", buf);
+	_dprintf("**** Upgraded CFE - Set PIN=%s\n", PIN);
 	usleep(100000);
 	reboot(RB_AUTOBOOT);
 }
-- 
2.25.1

