From 2e385caacc133999b1238ba2fea789c12039d71d Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Tue, 16 Feb 2021 12:55:49 +0800
Subject: [PATCH 108/122] softcenter: update to 1.1.0

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 .../router/softcenter/softcenter/.soft_ver    |  2 +-
 .../softcenter/softcenter/res/softcenter.css  | 25 +++++++++
 .../softcenter/scripts/ks_app_install.sh      | 47 +++++++++++++++-
 .../softcenter/scripts/ks_tar_install.sh      | 54 +++++++++++++++++--
 .../softcenter/webs/Module_Softcenter.asp     | 10 ----
 5 files changed, 120 insertions(+), 18 deletions(-)
 mode change 100755 => 100644 release/src/router/softcenter/softcenter/.soft_ver
 mode change 100755 => 100644 release/src/router/softcenter/softcenter/res/softcenter.css
 mode change 100755 => 100644 release/src/router/softcenter/softcenter/webs/Module_Softcenter.asp

diff --git a/release/src/router/softcenter/softcenter/.soft_ver b/release/src/router/softcenter/softcenter/.soft_ver
old mode 100755
new mode 100644
index 66c4c2263e..9084fa2f71
--- a/release/src/router/softcenter/softcenter/.soft_ver
+++ b/release/src/router/softcenter/softcenter/.soft_ver
@@ -1 +1 @@
-1.0.9
+1.1.0
diff --git a/release/src/router/softcenter/softcenter/res/softcenter.css b/release/src/router/softcenter/softcenter/res/softcenter.css
old mode 100755
new mode 100644
index 8285dc7c9a..a9f410b91f
--- a/release/src/router/softcenter/softcenter/res/softcenter.css
+++ b/release/src/router/softcenter/softcenter/res/softcenter.css
@@ -62,6 +62,28 @@
 	width: 740px;
 	margin: 1px 0;
 }
+.show-install-btn, .show-uninstall-btn {
+	border: none;
+	background: #444;
+	color: #fff;
+	padding: 10px 20px;
+	border-radius: 5px 5px 0px 0px;
+}
+.active {
+	background: #444f53;
+	border: none;
+}
+#soft_log {
+	width:99%;
+	font-family:'Lucida Console';
+	font-size:12px;
+	background:#475A5F;
+	color:#FFFFFF;
+	border:none;
+}
+#IconContainer {
+	border: none;
+}
 .ks_btn {
 	border: 1px solid #222;
 	font-size:10pt;
@@ -104,3 +126,6 @@
 	border:0px solid #222;
 	background:#475A5F;
 }
+.SimpleNote {
+	padding:5px 10px;
+}
diff --git a/release/src/router/softcenter/softcenter/scripts/ks_app_install.sh b/release/src/router/softcenter/softcenter/scripts/ks_app_install.sh
index ea9e99ccff..63fb674d13 100755
--- a/release/src/router/softcenter/softcenter/scripts/ks_app_install.sh
+++ b/release/src/router/softcenter/softcenter/scripts/ks_app_install.sh
@@ -5,7 +5,7 @@ source /koolshare/scripts/base.sh
 #
 # Copyright (C) 2019/2020 kooldev
 #
-# 此脚为arm384软件中心安装脚本。
+# 此脚为arm384/arm386软件中心安装脚本。
 # 软件中心地址: https://github.com/koolshare/armsoft
 #
 ###################################################
@@ -25,6 +25,26 @@ alias echo_date='echo 【$(TZ=UTC-8 date -R +%Y年%m月%d日\ %X)】:'
 eval $(dbus export softcenter_installing_)
 BIN_NAME=$(basename "$0")
 BIN_NAME="${BIN_NAME%.*}"
+ROG_86U=0
+BUILDNO=$(nvram get buildno)
+EXT_NU=$(nvram get extendno)
+EXT_NU=$(echo ${EXT_NU%_*} | grep -Eo "^[0-9]{1,10}$")
+[ -z "${EXT_NU}" ] && EXT_NU="0"
+
+if [ -n "$(nvram get extendno | grep koolshare)" -a "$(nvram get productid)" == "RT-AC86U" -a "${EXT_NU}" -lt "81918" -a "${BUILDNO}" != "386" ];then
+	ROG_86U=1
+fi
+
+MODEL=$(nvram get productid)
+if [ "$MODEL" == "GT-AC5300" -o "$MODEL" == "GT-AX11000" -o "$ROG_86U" == "1" ];then
+	# 官改固件，骚红皮肤
+	ROG=1
+fi
+
+if [ "$(nvram get productid)" == "TUF-AX3000" ];then
+	# 官改固件，橙色皮肤
+	TUF=1
+fi
 
 quit_ks_install(){
 	[ -n "${softcenter_installing_todo}" ] && rm -rf "/tmp/${softcenter_installing_todo}*"
@@ -201,7 +221,7 @@ install_ks_module() {
 	# fi
 
 	# 13. 检查.valid 字符串
-	# if [ -z "$(grep arm384 /tmp/${softcenter_installing_todo}/.valid)" ];then
+	# if [ -z "$(grep -w arm384 /tmp/${softcenter_installing_todo}/.valid)" ];then
 	# 	echo_date "软件中心：该插件包不能在本平台安装！"
 	# 	quit_ks_install
 	# fi
@@ -212,6 +232,29 @@ install_ks_module() {
 		cp -rf /tmp/${softcenter_installing_todo}/uninstall.sh /koolshare/scripts/uninstall_${softcenter_installing_todo}.sh
 	fi
 
+	# 15. 皮肤预处理-1，目前softwarece center采用ROG文件夹方式存放皮肤
+	if [ -d /tmp/${softcenter_installing_todo}/ROG -a "$ROG" == "1" ]; then
+		cp -rf /tmp/${softcenter_installing_todo}/ROG/* /tmp/${softcenter_installing_todo}/
+	fi
+	if [ -d /tmp/${softcenter_installing_todo}/ROG -a "$TUF" == "1" ]; then
+		find /tmp/${softcenter_installing_todo}/ROG/ -name "*.asp" | xargs sed -i 's/3e030d/3e2902/g;s/91071f/92650F/g;s/680516/D0982C/g;s/cf0a2c/c58813/g;s/700618/74500b/g;s/530412/92650F/g'
+		find /tmp/${softcenter_installing_todo}/ROG/ -name "*.css" | xargs sed -i 's/3e030d/3e2902/g;s/91071f/92650F/g;s/680516/D0982C/g;s/cf0a2c/c58813/g;s/700618/74500b/g;s/530412/92650F/g'
+		cp -rf /tmp/${softcenter_installing_todo}/ROG/* /tmp/${softcenter_installing_todo}/
+	fi
+
+	# 16. 皮肤预处理-2，一般来说插件的install.sh里会处理，但是避免一些插件没有处理，所以安装前先处理一次
+	if [ "$ROG" == "1" ];then
+		echo_date "为插件【${softcenter_installing_name}】安装ROG风格皮肤..."
+	else
+		if [ "$TUF" == "1" ];then
+			echo_date "为插件【${softcenter_installing_name}】安装TUF风格皮肤..."
+			sed -i 's/3e030d/3e2902/g;s/91071f/92650F/g;s/680516/D0982C/g;s/cf0a2c/c58813/g;s/700618/74500b/g;s/530412/92650F/g' /tmp/${softcenter_installing_todo}/webs/Module_${softcenter_installing_todo}.asp >/dev/null 2>&1
+		else
+			echo_date "为插件【${softcenter_installing_name}】安装ASUSWRT风格皮肤..."
+			sed -i '/rogcss/d' /tmp/${softcenter_installing_todo}/webs/Module_${softcenter_installing_todo}.asp >/dev/null 2>&1
+		fi
+	fi
+
 	# 17. 运行install.sh进行插件安装
 	echo_date "使用插件【${softcenter_installing_name}】提供的install.sh脚本进行安装..."
 	[ "${softcenter_installing_todo}" != "softcenter" ] && echo_date =========================== step 2 ================================
diff --git a/release/src/router/softcenter/softcenter/scripts/ks_tar_install.sh b/release/src/router/softcenter/softcenter/scripts/ks_tar_install.sh
index 0655c56314..148678077b 100755
--- a/release/src/router/softcenter/softcenter/scripts/ks_tar_install.sh
+++ b/release/src/router/softcenter/softcenter/scripts/ks_tar_install.sh
@@ -1,6 +1,6 @@
 #!/bin/sh
 
-# for arm384 platform
+# for arm384/arm386 platform
 
 export KSROOT=/koolshare
 source $KSROOT/scripts/base.sh
@@ -10,6 +10,24 @@ LOG_FILE_BACKUP=/tmp/upload/soft_install_log_backup.txt
 eval $(dbus export soft)
 TARGET_DIR=/tmp/upload
 MODEL=$(nvram get productid)
+ROG_86U=0
+EXT_NU=$(nvram get extendno)
+EXT_NU=$(echo ${EXT_NU%_*} | grep -Eo "^[0-9]{1,10}$")
+[ -z "${EXT_NU}" ] && EXT_NU="0"
+
+if [ -n "$(nvram get extendno | grep koolshare)" -a "$(nvram get productid)" == "RT-AC86U" -a "${EXT_NU}" -lt "81918" ];then
+	ROG_86U=1
+fi
+
+if [ "$MODEL" == "GT-AC5300" -o "$MODEL" == "GT-AX11000" -o "$ROG_86U" == "1" ];then
+	# 官改固件，骚红皮肤
+	ROG=1
+fi
+
+if [ "$(nvram get productid)" == "TUF-AX3000" ];then
+	# 官改固件，橙色皮肤
+	TUF=1
+fi
 
 jffs_space(){
 	local JFFS_AVAL=$(df | grep -w "/jffs" | awk '{print $4}')
@@ -84,7 +102,7 @@ install_tar(){
 
 			# 检查jffs空间，不可描述不做检测，交给插件自己处理
 			local JFFS_AVAL=$(jffs_space)
-			if [ "${MODULE_NAME}" != "shadowsocks" ];then
+			if [ "${MODULE_NAME}" != "shadowsocks" -a "${MODULE_NAME}" != "merlinclash" ];then
 				echo_date "检测jffs分区剩余空间..."
 				local JFFS_NEED=$(du -s /tmp/${MODULE_NAME} | awk '{print $1}')
 				local TAR_SIZE=$(du -s /tmp/${soft_name} | awk '{print $1}')
@@ -106,13 +124,13 @@ install_tar(){
 			fi
 
 			# 检查下安装包是否是hnd的
-			if [ -f "${SCRIPT_AB_DIR}/.valid" -a -n "$(grep arm384 ${SCRIPT_AB_DIR}/.valid)" ];then
+			if [ -f "${SCRIPT_AB_DIR}/.valid" -a -n "$(grep -w arm384 ${SCRIPT_AB_DIR}/.valid)" ];then
 				continue
 			elif [ "${MODULE_NAME}" == "shadowsocks" ];then
 				# hnd的不可描述包没有校验字符串，避免安装失败
 				continue
 			else
-				echo_date 你上传的离线安装包不是arm384平台的离线包！！！
+				echo_date 你上传的离线安装包不是arm384/arm386平台的离线包！！！
 				echo_date 请上传正确的离线安装包！！！
 				echo_date 删除相关文件并退出...
 				clean
@@ -129,6 +147,24 @@ install_tar(){
 			echo_date 运行安装脚本...
 			echo_date ====================== step 2 ===========================
 
+			if [ -d /tmp/${MODULE_NAME}/GT-AC5300 -a "$ROG" == "1" ]; then
+				cp -rf /tmp/${MODULE_NAME}/GT-AC5300/* /tmp/${MODULE_NAME}/
+			fi
+
+			if [ -d /tmp/${MODULE_NAME}/ROG -a "$ROG" == "1" ]; then
+				echo_date "检测到ROG官改皮肤，安装中..."
+				cp -rf /tmp/${MODULE_NAME}/ROG/* /tmp/${MODULE_NAME}/
+			fi
+
+			if [ -d /tmp/${MODULE_NAME}/ROG -a "$TUF" == "1" ]; then
+				# 骚红变橙色
+				echo_date "检测到TUF官改皮肤，安装中..."
+				find /tmp/${MODULE_NAME}/ROG/ -name "*.asp" | xargs sed -i 's/3e030d/3e2902/g;s/91071f/92650F/g;s/680516/D0982C/g;s/cf0a2c/c58813/g;s/700618/74500b/g;s/530412/92650F/g'
+				find /tmp/${MODULE_NAME}/ROG/ -name "*.css" | xargs sed -i 's/3e030d/3e2902/g;s/91071f/92650F/g;s/680516/D0982C/g;s/cf0a2c/c58813/g;s/700618/74500b/g;s/530412/92650F/g'
+				cp -rf /tmp/${MODULE_NAME}/ROG/* /tmp/${MODULE_NAME}/
+			fi
+
+			sleep 1
 			start-stop-daemon -S -q -x $INSTALL_SCRIPT 2>&1
 			if [ "$?" != "0" ];then
 				echo_date 因为${MODULE_NAME}插件安装失败！退出离线安装！
@@ -139,7 +175,15 @@ install_tar(){
 				exit
 			fi
 
-			sed -i '/rogcss/d' /koolshare/webs/Module_${MODULE_NAME}.asp >/dev/null 2>&1
+			if [ "$ROG" == "1" ];then
+				continue
+			else
+				if [ "$TUF" == "1" ];then
+					sed -i 's/3e030d/3e2902/g;s/91071f/92650F/g;s/680516/D0982C/g;s/cf0a2c/c58813/g;s/700618/74500b/g;s/530412/92650F/g' /koolshare/webs/Module_${MODULE_NAME}.asp >/dev/null 2>&1
+				else
+					sed -i '/rogcss/d' /koolshare/webs/Module_${MODULE_NAME}.asp >/dev/null 2>&1
+				fi
+			fi
 
 			echo_date ====================== step 3 ===========================
 			dbus set "softcenter_module_${MODULE_NAME}${NAME_SUFFIX}=${MODULE_NAME}"
diff --git a/release/src/router/softcenter/softcenter/webs/Module_Softcenter.asp b/release/src/router/softcenter/softcenter/webs/Module_Softcenter.asp
old mode 100755
new mode 100644
index 254cdcf023..282bd7c71a
--- a/release/src/router/softcenter/softcenter/webs/Module_Softcenter.asp
+++ b/release/src/router/softcenter/softcenter/webs/Module_Softcenter.asp
@@ -129,16 +129,6 @@ input[type=button]:focus {
 	width:60%;
 	border-right: 1px solid #000;
 }
-.show-install-btn, .show-uninstall-btn {
-	border: none;
-	background: #444;
-	color: #fff;
-	padding: 10px 20px;
-	border-radius: 5px 5px 0px 0px;
-}
-.active {
-	background: #444f53;
-}
 .install-status-1 .uninstall-btn {
 	display: block;
 }
-- 
2.25.1

