From 7f7e2764bcd4756ff71d12130889939d74106b2f Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Tue, 26 May 2020 22:14:50 +0800
Subject: [PATCH 035/122] k3init: upgrade CFE on first flash from other
 firmware.

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 release/src/router/rc/k3.c                    | 66 +++++++++++++++++++
 release/src/router/rc/k3.h                    |  4 ++
 release/src/router/rc/sysdeps/init-broadcom.c |  4 ++
 3 files changed, 74 insertions(+)

diff --git a/release/src/router/rc/k3.c b/release/src/router/rc/k3.c
index 22f610d2c2..17f0e07925 100644
--- a/release/src/router/rc/k3.c
+++ b/release/src/router/rc/k3.c
@@ -24,8 +24,74 @@
 #include <shutils.h>
 #include <siutils.h>
 #include <auth_common.h>
+#include <sys/reboot.h>
 #include "k3.h"
 
+#define ROMCFE "/rom/cfe"
+
+void envram_set(char *key, char *val)
+{
+	int i = 0;
+	while (!pids("envrams"))
+	{
+		if (i++ >= 5)
+			return;
+		system("/usr/sbin/envrams >/dev/null");
+		sleep(1);
+	}
+	doSystem("envram set %s='%s'", key, val);
+}
+
+void envram_commit(void)
+{
+	int i = 0;
+	while (!pids("envrams"))
+	{
+		if (i++ >= 5)
+			return;
+		system("/usr/sbin/envrams >/dev/null");
+		sleep(1);
+	}
+	system("envram commit");
+}
+
+void update_cfe_k3(void)
+{
+	char et0mac[18], wl1mac[18], wl2mac[18];
+	char buf[128];
+
+	if (!check_if_file_exist(ROMCFE) || cfe_nvram_match("bl_version", "1.0.37"))
+		return;
+	//if (pids("envrams"))
+		//sleep(5);
+
+	strcpy(et0mac, cfe_nvram_safe_get("et0macaddr"));
+	strcpy(wl1mac, cfe_nvram_safe_get("1:macaddr"));
+	strcpy(wl2mac, cfe_nvram_safe_get("2:macaddr"));
+
+	if (pids("envrams")) {
+		killall_tk("envrams");
+		usleep(100000);
+	}
+
+	doSystem("dd if=%s of=/dev/mtdblock0 2>/dev/null", ROMCFE);
+
+	envram_set("et0macaddr", et0mac);
+	envram_set("1:macaddr", wl1mac);
+	envram_set("2:macaddr", wl2mac);
+	envram_commit();
+
+	//if (pids("envrams"))
+		//killall_tk("envrams");
+
+	snprintf(buf, sizeof(buf), "Set CFE MAC: LAN=%s, 2.4G=%s, 5G=%s", et0mac, wl1mac, wl2mac);
+	//logmessage("K3INIT", "CFE has upgraded to 1.0.37 already!");
+	//logmessage("K3INIT", buf);
+	_dprintf("**** Upgraded CFE - %s\n", buf);
+	usleep(100000);
+	reboot(RB_AUTOBOOT);
+}
+
 void k3_init()
 {
 	bool isChange = 0;
diff --git a/release/src/router/rc/k3.h b/release/src/router/rc/k3.h
index 6fd8790b30..8617c807a8 100644
--- a/release/src/router/rc/k3.h
+++ b/release/src/router/rc/k3.h
@@ -15,6 +15,10 @@
  * MA 02111-1307 USA
  */
 
+void envram_set(char *key, char *val);
+void envram_commit(void);
+
+extern void update_cfe_k3(void);
 extern void k3_init(void);
 extern void k3_init_done(void);
 extern void start_k3screen(void);
diff --git a/release/src/router/rc/sysdeps/init-broadcom.c b/release/src/router/rc/sysdeps/init-broadcom.c
index 9242ede7ed..ae1896effe 100644
--- a/release/src/router/rc/sysdeps/init-broadcom.c
+++ b/release/src/router/rc/sysdeps/init-broadcom.c
@@ -14,6 +14,7 @@
 #include "shared.h"
 #include "version.h"
 #include "interface.h"
+#include "k3.h"
 
 #include <sched.h>
 #include <termios.h>
@@ -3940,6 +3941,9 @@ void init_others(void)
 #ifdef RTAC68U
 	ac68u_cofs();
 #endif
+#if defined(RTK3) && defined(RTCONFIG_ROMCFE)
+	update_cfe_k3();
+#endif
 }
 #endif	// HND_ROUTER
 #endif	// RTCONFIG_BCMARM
-- 
2.25.1

