From 4e3bd12ee98c646051f59debad825912ccedf6bb Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Wed, 6 May 2020 00:46:35 +0800
Subject: [PATCH 025/122] upgrade: seprate cfe from image(useless for now).

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 release/src/router/httpd/web.c                | 30 +++++++++++++++++--
 .../src/router/shared/sysdeps/api-broadcom.c  |  5 ++++
 2 files changed, 32 insertions(+), 3 deletions(-)

diff --git a/release/src/router/httpd/web.c b/release/src/router/httpd/web.c
index 4e97205999..04640f498f 100644
--- a/release/src/router/httpd/web.c
+++ b/release/src/router/httpd/web.c
@@ -13157,6 +13157,7 @@ do_upgrade_post(char *url, FILE *stream, int len, char *boundary)
 	char *reset = safe_get_cgi_json("reset",NULL);
 
 	char upload_fifo[64] = "/tmp/linux.trx";
+	char *upload_fifo_cfe = "/tmp/cfe.bin";
 	FILE *fifo = NULL;
 	char buf[4096];
 	int ch/*, ver_chk = 0*/;
@@ -13261,6 +13262,8 @@ do_upgrade_post(char *url, FILE *stream, int len, char *boundary)
 	filelen = len;
 	cnt = 0;
 	offset = 0;
+	int ret_chk = 0, left_wr = 0;
+	const int size_cfe = 512*1024; //512kb
 
 	/* Pipe the rest to the FIFO */
 	while (len>0 && filelen>0)
@@ -13284,7 +13287,7 @@ do_upgrade_post(char *url, FILE *stream, int len, char *boundary)
 		}
 #endif
 
-		count = fread(buf + offset, 1, MIN(len, sizeof(buf)-offset), stream);
+		count = fread(buf + offset, 1, MIN(MIN(len, sizeof(buf)-offset), filelen), stream);
 
 		if(count <= 0)
 			goto err;
@@ -13308,12 +13311,32 @@ do_upgrade_post(char *url, FILE *stream, int len, char *boundary)
 			_dprintf("read from stream: %d\n", count);
 			cnt++;
 
-			if(!check_imageheader(buf, &filelen)) {
+			ret_chk = check_imageheader(buf, &filelen);
+			if(!ret_chk) {
 				goto err;
+			} else if(ret_chk == 2) {
+				if (fifo)
+					fclose(fifo);
+				if (!(fifo = fopen(upload_fifo_cfe, "w"))) goto err;
+				left_wr = size_cfe;
 			}
 		}
 		filelen-=count;
-		fwrite(buf, 1, count, fifo);
+		if(ret_chk == 2) {
+			left_wr -= count;
+			if(left_wr >= 0)
+				fwrite(buf, 1, count, fifo);
+			if(filelen <= 0) {
+				fclose(fifo);
+				if (!(fifo = fopen(upload_fifo, "w"))) goto err;
+				filelen = len;
+				cnt = 0;
+			}
+		}
+		else if(ret_chk == 1)
+		{
+			fwrite(buf, 1, count, fifo);
+		}
 	}
 
 #ifdef HND_ROUTER
@@ -13426,6 +13449,7 @@ do_upgrade_cgi(char *url, FILE *stream)
 			nvram_set_int("upgrade_fw_status", FW_TRX_CHECK_ERROR);
 		else	/* 1: illegal image */
 			nvram_set_int("upgrade_fw_status", FW_WRITING_ERROR);
+		unlink("/tmp/cfe.bin");
 		unlink("/tmp/linux.trx");
 
 		if (stop_upgrade_once) {
diff --git a/release/src/router/shared/sysdeps/api-broadcom.c b/release/src/router/shared/sysdeps/api-broadcom.c
index 7c797bc841..4f911fc8b4 100644
--- a/release/src/router/shared/sysdeps/api-broadcom.c
+++ b/release/src/router/shared/sysdeps/api-broadcom.c
@@ -2053,6 +2053,7 @@ uint32_t set_phy_ctrl(uint32_t portmask, int ctrl)
 }
 
 #define IMAGE_HEADER "HDR0"
+#define CFE_HEADER "\xFF\x04\x00\xEA"
 #define MAX_VERSION_LEN 64
 #define MAX_PID_LEN 12
 #define MAX_HW_COUNT 4
@@ -2145,6 +2146,10 @@ int check_imageheader(char *buf, long *filelen)
 #endif
 		_dprintf("image len: %x\n", aligned);
 		return 1;
+	} else if(memcmp(buf, CFE_HEADER, sizeof(CFE_HEADER) - 1) == 0) {
+		_dprintf("found cfe image.\n");
+		*filelen = (512 + 1) * 1024; //512kb cfe, and 1kb phicomm_inno
+		return 2;
 	}
 	else return 0;
 }
-- 
2.25.1

