From c470e1b26f4a653df8f128fe2e457a73ed0ec0a8 Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Fri, 2 Apr 2021 21:14:30 +0800
Subject: [PATCH 120/122] rc: for safety, use mtd-write to flash cfe instead.

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 release/src/router/Makefile     | 2 +-
 release/src/router/rc/k3.c      | 5 +++--
 release/src/router/rom/Makefile | 5 +++++
 3 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/release/src/router/Makefile b/release/src/router/Makefile
index fc9aacea56..4bee960560 100644
--- a/release/src/router/Makefile
+++ b/release/src/router/Makefile
@@ -2331,7 +2331,7 @@ else
 endif
 
 ifeq ($(RTCONFIG_ROMCFE),y)
-	-cp $(SRCBASE)/cfe/cfe_`echo $(BUILD_NAME)|tr A-Z a-z`.bin $(TARGETDIR)/rom/cfe
+	-cp $(SRCBASE)/cfe/cfe_`echo $(BUILD_NAME)|tr A-Z a-z`.bin $(TARGETDIR)/rom/cfe/
 endif
 ifeq ($(RTCONFIG_ROMATECCODEFIX),y)
 	-cp $(SRCBASE)/router/rom/cfe/`echo $(BUILD_NAME)|tr A-Z a-z`_fixlist.txt $(TARGETDIR)/rom/mac_chklist.txt
diff --git a/release/src/router/rc/k3.c b/release/src/router/rc/k3.c
index 460e8fde60..cbda716702 100644
--- a/release/src/router/rc/k3.c
+++ b/release/src/router/rc/k3.c
@@ -26,7 +26,7 @@
 #include <auth_common.h>
 #include <sys/reboot.h>
 
-#define ROMCFE "/rom/cfe"
+#define ROMCFE "/rom/cfe/cfe_rt-k3.bin"
 
 void envram_set(char *key, char *val)
 {
@@ -121,7 +121,8 @@ void update_cfe_k3(void)
 		usleep(100000);
 	}
 
-	doSystem("dd if=%s of=/dev/mtdblock0 2>/dev/null", ROMCFE);
+	doSystem("/rom/cfe/mtd-write %s boot", ROMCFE);
+	usleep(100000);
 
 	envram_set("et0macaddr", et0mac);
 	envram_set("0:macaddr", et0mac); // 2.4G MAC is the same as LAN MAC in Merlin
diff --git a/release/src/router/rom/Makefile b/release/src/router/rom/Makefile
index 0785d63f1f..53f6bb247e 100644
--- a/release/src/router/rom/Makefile
+++ b/release/src/router/rom/Makefile
@@ -310,6 +310,11 @@ ifeq ($(RTAC3200),y)
 	cp -rf cfe/mtd-write $(INSTALLDIR)/rom/cfe/
 endif
 
+ifeq ($(RTK3),y)
+	mkdir -p $(INSTALLDIR)/rom/cfe
+	cp -rf cfe/mtd-write $(INSTALLDIR)/rom/cfe/
+endif
+
 ifeq ($(RTCONFIG_MEDIA_SERVER),y)
 	mkdir -p $(INSTALLDIR)/rom/dlna
 ifeq ($(BUILD_NAME), RT-AC68U)
-- 
2.25.1

