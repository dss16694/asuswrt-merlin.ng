From 00227f80fb96c645a72bbfaeeb671956c90ea5e2 Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Sun, 12 Apr 2020 23:02:15 +0800
Subject: [PATCH 003/122] =?UTF-8?q?1.=E6=B7=BB=E5=8A=A0K3=E5=86=85?=
 =?UTF-8?q?=E6=A0=B8=E5=85=A5=E5=8F=A3=E5=9C=B0=E5=9D=80=EF=BC=8C=E5=8C=B9?=
 =?UTF-8?q?=E9=85=8D=E5=8E=9F=E5=8E=82CFE(by=20lostlonger)=20=20=20Add=20K?=
 =?UTF-8?q?3=20kernel=20boot=20address=20of=20orignal=20CFE=202.=E6=B7=BB?=
 =?UTF-8?q?=E5=8A=A0=E5=88=86=E5=8C=BA"phicomm"=EF=BC=8C=E4=BF=9D=E6=8A=A4?=
 =?UTF-8?q?=E5=8E=9F=E5=8E=82=E6=9C=BA=E5=99=A8=E4=BF=A1=E6=81=AF=E5=88=86?=
 =?UTF-8?q?=E5=8C=BA0x180000-0x400000(by=20lostlonger)=20=20=20Add=20mtd?=
 =?UTF-8?q?=5Fpartitions=20"phicomm",in=20order=20to=20protect=20orignal?=
 =?UTF-8?q?=20devinfo=20used=20by=20phicomm?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 .../src-rt-7.14.114.x/src/include/hndnand.h   | 14 +++++++--
 .../arch/arm/mach-brcm-hnd/board_ns.c         | 29 +++++++++++++++++--
 2 files changed, 38 insertions(+), 5 deletions(-)

diff --git a/release/src-rt-7.14.114.x/src/include/hndnand.h b/release/src-rt-7.14.114.x/src/include/hndnand.h
index 19a21a5eea..069f4ece87 100644
--- a/release/src-rt-7.14.114.x/src/include/hndnand.h
+++ b/release/src-rt-7.14.114.x/src/include/hndnand.h
@@ -2,11 +2,11 @@
  * Broadcom chipcommon NAND flash interface
  *
  * Copyright (C) 2015, Broadcom Corporation. All Rights Reserved.
- * 
+ *
  * Permission to use, copy, modify, and/or distribute this software for any
  * purpose with or without fee is hereby granted, provided that the above
  * copyright notice and this permission notice appear in all copies.
- * 
+ *
  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY
@@ -35,7 +35,12 @@
 #define NFL_SECTOR_SIZE			512
 #define NFL_TABLE_END			0xffffffff
 
+//Add Phicomm K3 boot address
+#ifdef RTK3
+#define NFL_BOOT_SIZE			0x400000
+#else
 #define NFL_BOOT_SIZE			0x200000
+#endif
 /* ASUS LINUX MTD SIZE */
 #if CONFIG_LINUX_MTD == 32
  #define NFL_BOOT_OS_SIZE                      0x2000000
@@ -49,7 +54,12 @@
 #define NFL_BBT_SIZE			0x100000
 
 #ifdef __ARM_ARCH_7A__
+//Add Phicomm K3 boot address
+#ifdef RTK3
+#define NFL_BIG_BOOT_SIZE		0x400000	/* 4 MB */
+#else
 #define NFL_BIG_BOOT_SIZE		0x800000	/* 8 MB */
+#endif
 #define NFL_BIG_BOOT_OS_SIZE		0x2600000	/* 38 MB */
 #define NFL_1M_BLOCK_SIZE		1024		/* KB */
 
diff --git a/release/src-rt-7.14.114.x/src/linux/linux-2.6.36/arch/arm/mach-brcm-hnd/board_ns.c b/release/src-rt-7.14.114.x/src/linux/linux-2.6.36/arch/arm/mach-brcm-hnd/board_ns.c
index 580e546d83..7a9ba046ea 100644
--- a/release/src-rt-7.14.114.x/src/linux/linux-2.6.36/arch/arm/mach-brcm-hnd/board_ns.c
+++ b/release/src-rt-7.14.114.x/src/linux/linux-2.6.36/arch/arm/mach-brcm-hnd/board_ns.c
@@ -177,7 +177,7 @@ void __init board_init_irq(void)
 {
 early_printk("board_init_irq\n");
 	soc_init_irq();
-	
+
 	/* serial_setup(sih); */
 }
 
@@ -296,6 +296,11 @@ static int __init rootfs_mtdblock(void)
 	int bootdev;
 	int knldev;
 	int block = 0;
+#ifdef RTK3
+	const int num = 4; // mtd4 "linux"
+#else
+	const int num = 3; // mtd3 "linux"
+#endif
 #ifdef CONFIG_FAILSAFE_UPGRADE
 	char *img_boot = nvram_get(BOOTPARTITION);
 #endif
@@ -313,9 +318,9 @@ static int __init rootfs_mtdblock(void)
 		if (img_boot && simple_strtol(img_boot, NULL, 10))
 			return 5;
 		else
-			return 3;
+			return num;
 #else
-		return 3;
+		return num;
 #endif
 	}
 
@@ -1032,6 +1037,23 @@ init_nflash_mtd_partitions(hndnand_t *nfl, struct mtd_info *mtd, size_t size)
 		offset = bcm947xx_nflash_parts[nparts].size;
 		nparts++;
 
+#ifdef RTK3
+		/* Setup NVRAM MTD partition */
+		bcm947xx_nflash_parts[nparts].name = "nvram";
+		bcm947xx_nflash_parts[nparts].size = 0x100000;
+		bcm947xx_nflash_parts[nparts].offset = offset;
+
+		offset += bcm947xx_nflash_parts[nparts].size;
+		nparts++;
+
+		/* Setup phicomm partition */
+		bcm947xx_nflash_parts[nparts].name = "phicomm";
+		bcm947xx_nflash_parts[nparts].size = nfl_boot_size(nfl) - offset;
+		bcm947xx_nflash_parts[nparts].offset = offset;
+
+		offset = nfl_boot_size(nfl);
+		nparts++;
+#else
 		/* Setup NVRAM MTD partition */
 		bcm947xx_nflash_parts[nparts].name = "nvram";
 		bcm947xx_nflash_parts[nparts].size = nfl_boot_size(nfl) - offset;
@@ -1039,6 +1061,7 @@ init_nflash_mtd_partitions(hndnand_t *nfl, struct mtd_info *mtd, size_t size)
 
 		offset = nfl_boot_size(nfl);
 		nparts++;
+#endif
 	}
 
 	if (knldev == SOC_KNLDEV_NANDFLASH) {
-- 
2.25.1

