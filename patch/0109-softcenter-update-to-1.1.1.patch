From 73dea79c9e4492e9427311ea9463725b499f99df Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Tue, 16 Feb 2021 17:13:32 +0800
Subject: [PATCH 109/122] softcenter: update to 1.1.1

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 release/src/router/softcenter/jffsinit.sh     | 32 ++++++++++++++++++-
 release/src/router/softcenter/koolshare-reset |  3 +-
 .../router/softcenter/softcenter/.soft_ver    |  2 +-
 .../softcenter/scripts/ks_app_install.sh      |  1 -
 .../softcenter/scripts/ks_tar_install.sh      |  1 -
 5 files changed, 34 insertions(+), 5 deletions(-)

diff --git a/release/src/router/softcenter/jffsinit.sh b/release/src/router/softcenter/jffsinit.sh
index b1db84fba6..d966d62c91 100755
--- a/release/src/router/softcenter/jffsinit.sh
+++ b/release/src/router/softcenter/jffsinit.sh
@@ -1,8 +1,29 @@
 #!/bin/sh
 
+# detect basic_center and remove it
+if [ -d "/jffs/.basic_center" ];then
+	rm -rf /jffs/.basic_center
+	[ -d "/jffs/db" ] && rm -rf /jffs/db
+	[ -d "/jffs/asdb" ] && rm -rf /jffs/asdb
+	[ -L "/jffs/etc/profile" ] && rm -rf /jffs/etc
+	[ -L "/jffs/configs/profile.add" ] && rm -rf /jffs/configs
+	sync
+fi
+
+# http web should work under port 80
+if [ "$(nvram get http_lanport)" != "80" -o -n "$(ps|grep -w httpd|grep -v grep|grep 81)" ];then
+	nvram set http_lanport=80
+	nvram commit
+	service restart_httpd >/dev/null 2>&1
+fi
+
+# remove files after router started, incase dnsmasq won't start
+[ -d "/jffs/configs/dnsmasq.d" ] && rm -rf /jffs/configs/dnsmasq.d/*
+
 # make some folders
 mkdir -p /jffs/scripts
 mkdir -p /jffs/configs/dnsmasq.d
+mkdir -p /jffs/etc
 mkdir -p /tmp/upload
 
 # install all
@@ -13,6 +34,7 @@ else
 fi
 ROM_VERSION=$(cat /rom/etc/koolshare/.soft_ver)
 COMP=$(/rom/etc/koolshare/bin/versioncmp $CUR_VERSION $ROM_VERSION)
+
 if [ ! -d "/jffs/.koolshare" -o "$COMP" == "1" ]; then
 	#cp -a /rom/etc/koolshare/ /jffs/.koolshare
 	mkdir -p /jffs/.koolshare
@@ -26,10 +48,17 @@ if [ ! -d "/jffs/.koolshare" -o "$COMP" == "1" ]; then
 	chmod 755 /koolshare/perp/.control/*
 	chmod 755 /koolshare/perp/httpdb/*
 	chmod 755 /koolshare/scripts/*
+	# make some link
 	[ ! -L "/koolshare/bin/base64_decode" ] && ln -sf /koolshare/bin/base64_encode /koolshare/bin/base64_decode
 	[ ! -L "/koolshare/scripts/ks_app_remove.sh" ] && ln -sf /koolshare/scripts/ks_app_install.sh /koolshare/scripts/ks_app_remove.sh
 	[ ! -L "/jffs/.asusrouter" ] && ln -sf /koolshare/bin/kscore.sh /jffs/.asusrouter
-	[ ! -L "/jffs/configs/profile.add" ] && ln -sf /koolshare/scripts/base.sh /jffs/configs/profile.add
+	if [ -n "$(nvram get extendno | grep koolshare)" ];then
+		# for offcial mod, RT-AC86U, GT-AC5300, TUF-AX3000, RT-AX86U, etc
+		[ ! -L "/jffs/etc/profile" ] && ln -sf /koolshare/scripts/base.sh /jffs/etc/profile
+	else
+		# for Merlin mod, RT-AX88U, RT-AC86U, etc
+		[ ! -L "/jffs/configs/profile.add" ] && ln -sf /koolshare/scripts/base.sh /jffs/configs/profile.add
+	fi
 	#service restart_skipd
 fi
 
@@ -82,3 +111,4 @@ else
 	[ "$STARTCOMAND4" == "0" ] && sed -i '1a /koolshare/bin/ks-services-start.sh start' /jffs/scripts/services-start
 fi
 
+sync
diff --git a/release/src/router/softcenter/koolshare-reset b/release/src/router/softcenter/koolshare-reset
index 0956ba51d1..553e4d8788 100755
--- a/release/src/router/softcenter/koolshare-reset
+++ b/release/src/router/softcenter/koolshare-reset
@@ -10,6 +10,7 @@ sh perp.sh stop >/dev/null 2>&1
 # remove software center files
 cd /
 rm -rf /jffs/db
+rm -rf /jffs/ksdb
 rm -rf /jffs/.asusrouter
 rm -rf /jffs/.koolshare
 rm -rf /jffs/scripts/dnsmasq.postconf
@@ -23,4 +24,4 @@ jffsinit.sh >/dev/null 2>&1
 cd /koolshare/perp
 sh perp.sh start >/dev/null 2>&1
 
-echo "软件中心完成，请清空浏览器缓存后重新进入软件中心！"
\ No newline at end of file
+echo "软件中心完成，请清空浏览器缓存后重新进入软件中心！"
diff --git a/release/src/router/softcenter/softcenter/.soft_ver b/release/src/router/softcenter/softcenter/.soft_ver
index 9084fa2f71..524cb55242 100644
--- a/release/src/router/softcenter/softcenter/.soft_ver
+++ b/release/src/router/softcenter/softcenter/.soft_ver
@@ -1 +1 @@
-1.1.0
+1.1.1
diff --git a/release/src/router/softcenter/softcenter/scripts/ks_app_install.sh b/release/src/router/softcenter/softcenter/scripts/ks_app_install.sh
index 63fb674d13..1e3be15bc0 100755
--- a/release/src/router/softcenter/softcenter/scripts/ks_app_install.sh
+++ b/release/src/router/softcenter/softcenter/scripts/ks_app_install.sh
@@ -259,7 +259,6 @@ install_ks_module() {
 	echo_date "使用插件【${softcenter_installing_name}】提供的install.sh脚本进行安装..."
 	[ "${softcenter_installing_todo}" != "softcenter" ] && echo_date =========================== step 2 ================================
 	chmod a+x /tmp/${softcenter_installing_todo}/install.sh
-	sed -i "s/ 384/ 386/g" /tmp/${softcenter_installing_todo}/install.sh
 	# 使用start-stop-daemon，而不是shell fork，避免可能得install.sh问题导致ks_app_install.sh卡死
 	# sh /tmp/${softcenter_installing_todo}/install.sh
 	start-stop-daemon -S -q -x /tmp/${softcenter_installing_todo}/install.sh 2>&1
diff --git a/release/src/router/softcenter/softcenter/scripts/ks_tar_install.sh b/release/src/router/softcenter/softcenter/scripts/ks_tar_install.sh
index 148678077b..8f0237553a 100755
--- a/release/src/router/softcenter/softcenter/scripts/ks_tar_install.sh
+++ b/release/src/router/softcenter/softcenter/scripts/ks_tar_install.sh
@@ -143,7 +143,6 @@ install_tar(){
 			echo_date 准备安装${MODULE_NAME}插件！
 			echo_date 找到安装脚本！
 			chmod +x $INSTALL_SCRIPT >/dev/null 2>&1
-			sed -i "s/ 384/ 386/g" $INSTALL_SCRIPT >/dev/null 2>&1
 			echo_date 运行安装脚本...
 			echo_date ====================== step 2 ===========================
 
-- 
2.25.1

