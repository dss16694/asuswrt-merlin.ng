From 5cfb408bee6c84710ed031494b51097c17d5fd5f Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Sun, 9 Aug 2020 18:28:23 +0800
Subject: [PATCH 076/122] rc: combine k3screenbg into k3screenctrl.

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 release/src/router/rc/k3.c       | 17 +++--------------
 release/src/router/rc/watchdog.c |  7 ++++---
 2 files changed, 7 insertions(+), 17 deletions(-)

diff --git a/release/src/router/rc/k3.c b/release/src/router/rc/k3.c
index 4b42555b46..0e96c4c293 100644
--- a/release/src/router/rc/k3.c
+++ b/release/src/router/rc/k3.c
@@ -117,7 +117,7 @@ void update_cfe_k3(void)
 	envram_set("et0macaddr", et0mac);
 	envram_set("1:macaddr", et0mac); // 2.4G MAC is the same as LAN MAC in Merlin
 	envram_set("2:macaddr", wl2mac);
-	if (cfe_nvram_safe_get("1:macbak") == "")
+	if (!strlen(cfe_nvram_safe_get("1:macbak")))
 		envram_set("1:macbak", wl1mac); // Backup 2.4G MAC
 	envram_set("secret_code", PIN);
 	envram_commit();
@@ -179,26 +179,15 @@ void start_k3screen(void)
 	int time = nvram_get_int("screen_timeout");
 	snprintf(timeout, sizeof(timeout), "-m%d", time);
 	char *k3screenctrl_argv[] = {"k3screenctrl", timeout, NULL}; //screen timeout 30sec
-	char *k3screenbg_argv[] = {"k3screenbg", NULL};
-	pid_t pid1, pid2;
+	pid_t pid1;
 
 	killall_tk("k3screenctrl");
-	killall_tk("k3screenbg");
 
 	logmessage("K3INIT", "屏幕控制程序开始启动");
 	_dprintf("**** k3screen: start\n");
 	mkdir_if_none("/tmp/k3screenctrl");
 	doSystem("ln -snf /lib/k3screenctrl/* /tmp/k3screenctrl");
-	_eval(k3screenbg_argv, NULL, 0, &pid1);
-	_eval(k3screenctrl_argv, NULL, 0, &pid2);
-	if (!nvram_get("mcu_version"))
-	{
-		pid_t pid3;
-		sleep(3);
-		_eval(k3screenctrl_argv, NULL, 0, &pid3);
-		sleep(1);
-		kill(-pid3, SIGKILL);
-	}
+	_eval(k3screenctrl_argv, NULL, 0, &pid1);
 	_dprintf("**** k3screen: ok\n");
 }
 
diff --git a/release/src/router/rc/watchdog.c b/release/src/router/rc/watchdog.c
index 6a5ac5b90f..61b9deb903 100644
--- a/release/src/router/rc/watchdog.c
+++ b/release/src/router/rc/watchdog.c
@@ -6561,14 +6561,15 @@ void k3screen_check()
 	{
 		return;
 	}
-	if (!pids("k3screenbg"))
+	/*if (!pids("k3screenbg"))
 	{
 		char *k3screend_argv[] = { "k3screenbg", NULL };
 		pid_t pid;
 		_eval(k3screend_argv, NULL, 0, &pid);
 		logmessage("watchdog", "restart k3screenbg");
-	}
-	if (!pids("k3screenctrl")){
+	}*/
+	if (!pids("k3screenctrl"))
+	{
 		char timeout[6];
 		int time = nvram_get_int("screen_timeout");
 		snprintf(timeout, sizeof(timeout), "-m%d", time);
-- 
2.25.1

