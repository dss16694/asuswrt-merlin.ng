From 93cbeca6b1424826e7e0908c82ae97529015d86d Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Sun, 24 Jan 2021 22:03:23 +0800
Subject: [PATCH 093/122] add new debug print: kprintf

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 release/src/router/rc/k3.c         | 10 +++++-----
 release/src/router/shared/shared.h |  2 ++
 2 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/release/src/router/rc/k3.c b/release/src/router/rc/k3.c
index 0e96c4c293..d2d1ac6092 100644
--- a/release/src/router/rc/k3.c
+++ b/release/src/router/rc/k3.c
@@ -131,8 +131,8 @@ void update_cfe_k3(void)
 	snprintf(buf, sizeof(buf), "Set CFE MAC: LAN & 2.4G=%s, 2.4G_bak=%s, 5G=%s", et0mac, wl1mac, wl2mac);
 	//logmessage("K3INIT", "CFE has upgraded to 1.0.37_mesh already!");
 	//logmessage("K3INIT", buf);
-	_dprintf("**** Upgraded CFE - %s\n", buf);
-	_dprintf("**** Upgraded CFE - Set PIN=%s\n", PIN);
+	kprintf("Upgraded CFE - %s\n", buf);
+	kprintf("Upgraded CFE - Set PIN=%s\n", PIN);
 	usleep(100000);
 	reboot(RB_AUTOBOOT);
 }
@@ -169,7 +169,7 @@ void k3_init_done()
 		system("/koolshare/bin/ks-services-start.sh start");
 	}
 	logmessage("K3INIT", "软件中心初始化完成");
-	_dprintf("**** softcenter: init done\n");
+	kprintf("softcenter: init done\n");
 #endif
 }
 
@@ -184,11 +184,11 @@ void start_k3screen(void)
 	killall_tk("k3screenctrl");
 
 	logmessage("K3INIT", "屏幕控制程序开始启动");
-	_dprintf("**** k3screen: start\n");
+	kprintf("k3screen: start\n");
 	mkdir_if_none("/tmp/k3screenctrl");
 	doSystem("ln -snf /lib/k3screenctrl/* /tmp/k3screenctrl");
 	_eval(k3screenctrl_argv, NULL, 0, &pid1);
-	_dprintf("**** k3screen: ok\n");
+	kprintf("k3screen: ok\n");
 }
 
 int GetPhyStatusk3(int verbose)
diff --git a/release/src/router/shared/shared.h b/release/src/router/shared/shared.h
index 0ac33a175c..64a908b8c2 100644
--- a/release/src/router/shared/shared.h
+++ b/release/src/router/shared/shared.h
@@ -353,10 +353,12 @@ extern void set_basic_fw_name(void);
 #define _dprintf		cprintf
 #define csprintf		cprintf
 #define dprintf			cprintf
+#define kprintf(fmt, args...) (cprintf("**** %s[%s(%d)] "fmt, __FILE__, __FUNCTION__, __LINE__, ## args));
 #else
 #define _dprintf(args...)	do { } while(0)
 #define csprintf(args...)	do { } while(0)
 #define dprintf(args...)	do { } while(0)
+#define kprintf(args...)	do { } while(0)
 #endif
 
 #define ASUS_STOP_COMMIT	"asus_stop_commit"
-- 
2.25.1

