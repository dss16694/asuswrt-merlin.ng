From d5dd805fb4cd50405625354c774fc5029ff59772 Mon Sep 17 00:00:00 2001
From: Rokis <ghost1988102@gmail.com>
Date: Sun, 24 Jan 2021 22:05:01 +0800
Subject: [PATCH 094/122] rc: add UU plugin & TC plugin.

Signed-off-by: Rokis <ghost1988102@gmail.com>
---
 release/src/router/rc/init.c |   3 ++
 release/src/router/rc/k3.c   | 101 +++++++++++++++++++++++++++++++++++
 release/src/router/rc/ntp.c  |   8 ++-
 release/src/router/rc/ntpd.c |   7 +++
 4 files changed, 117 insertions(+), 2 deletions(-)

diff --git a/release/src/router/rc/init.c b/release/src/router/rc/init.c
index d6ad4abc55..98a8bb529f 100644
--- a/release/src/router/rc/init.c
+++ b/release/src/router/rc/init.c
@@ -11469,6 +11469,9 @@ int init_nvram(void)
 #else
 		add_rc_support("mssid 2.4G 5G usbX2");
 #endif
+#ifdef RTCONFIG_TCPLUGIN
+		add_rc_support("tencent_qmacc");
+#endif
 #ifdef RTCONFIG_MERLINUPDATE
 		add_rc_support("update");
 #else
diff --git a/release/src/router/rc/k3.c b/release/src/router/rc/k3.c
index d2d1ac6092..0cb1c20a52 100644
--- a/release/src/router/rc/k3.c
+++ b/release/src/router/rc/k3.c
@@ -232,3 +232,104 @@ int GetPhyStatusk3(int verbose)
 
 	return lret;
 }
+
+#ifdef RTCONFIG_UUPLUGIN
+void exec_uu_k3(void)
+{
+	FILE *fpmodel, *fpmac, *fpuu, *fpurl, *fpmd5, *fpcfg;
+	char buf[128];
+	int download, i;
+	char *dup, *url, *md5;
+
+	if(nvram_get_int("sw_mode") == 1)
+	{
+		add_rc_support("uu_accel");
+		if ((fpmodel = fopen("/var/model", "w")))
+		{
+			fprintf(fpmodel, nvram_get("productid"));
+			fclose(fpmodel);
+		}
+		if ((fpmac = fopen("/var/label_macaddr", "w")))
+		{
+			char *etmac = get_label_mac();
+			toLowerCase(etmac);
+			fprintf(fpmac, etmac);
+			fclose(fpmac);
+		}
+		if ((fpuu = fopen("/var/uu_plugin_dir", "w")))
+		{
+			fprintf(fpuu, "/jffs");
+			fclose(fpuu);
+		}
+		system("mkdir -p /tmp/uu");
+		download = system("wget -t 2 -T 30 --dns-timeout=120 --header=Accept:text/plain -q --no-check-certificate 'https://router.uu.163.com/api/script/monitor?type=asuswrt-merlin' -O /tmp/uu/script_url");
+		if (!download)
+		{
+			kprintf("download uuplugin script info successfully\n");
+			if (fpurl = fopen("/tmp/uu/script_url", "r"))
+			{
+				fgets(buf, 128, fpurl);
+				fclose(fpurl);
+				unlink("/tmp/uu/script_url");
+				dup = strdup(buf);
+				url = strsep(&dup, ",");
+				md5 = strsep(&dup, ",");
+				if (md5 != NULL)
+				{
+					kprintf("URL: %s\n", url);
+					kprintf("MD5: %s\n", md5);
+					if (!doSystem("wget -t 2 -T 30 --dns-timeout=120 --header=Accept:text/plain -q --no-check-certificate %s -O /tmp/uu/uuplugin_monitor.sh", url))
+					{
+						kprintf("download uuplugin script successfully\n");
+						if ((fpcfg = fopen("/tmp/uu/uuplugin_monitor.config", "w")))
+						{
+							fprintf(fpcfg, "router=asuswrt-merlin\n");
+							fprintf(fpcfg, "model=RT-AC3100\n");
+							fclose(fpcfg);
+						}
+						if ((fpmd5=popen("md5sum /tmp/uu/uuplugin_monitor.sh | awk '{print $1}'", "r")))
+						{
+							bzero(buf, sizeof(buf));
+							if((fread(buf, 1, 128, fpmd5)))
+							{
+								if (!strncasecmp(buf, md5, 32))
+								{
+									pid_t pid;
+									char *uu_argv[] = { "/tmp/uu/uuplugin_monitor.sh", NULL };
+									kprintf("prepare to execute uuplugin stript...\n");
+									chmod("/tmp/uu/uuplugin_monitor.sh", 0755);
+									_eval(uu_argv, NULL, 0, &pid);
+								}
+							}
+							pclose(fpmd5);
+						}
+					}
+				}
+				free(dup);
+			}
+		}
+	}
+}
+#endif
+
+#ifdef RTCONFIG_TCPLUGIN
+void exec_tcplugin(void)
+{
+	FILE *fpmodel, *fpmac;
+	if (nvram_get_int("sw_mode") == 1)
+	{
+		if ((fpmodel = fopen("/var/model", "w")))
+		{
+			fprintf(fpmodel, nvram_get("productid"));
+			fclose(fpmodel);
+		}
+	}
+	if ((fpmac = fopen("/var/label_macaddr", "w")))
+	{
+		char *etmac = get_label_mac();
+		toLowerCase(etmac);
+		fprintf(fpmac, etmac);
+		fclose(fpmac);
+	}
+}
+#endif
diff --git a/release/src/router/rc/ntp.c b/release/src/router/rc/ntp.c
index 1956e35472..fc371d7815 100644
--- a/release/src/router/rc/ntp.c
+++ b/release/src/router/rc/ntp.c
@@ -16,14 +16,14 @@
  *
  * Copyright 2004, ASUSTeK Inc.
  * All Rights Reserved.
- * 
+ *
  * THIS SOFTWARE IS OFFERED "AS IS", AND ASUS GRANTS NO WARRANTIES OF ANY
  * KIND, EXPRESS OR IMPLIED, BY STATUTE, COMMUNICATION OR OTHERWISE. BROADCOM
  * SPECIFICALLY DISCLAIMS ANY IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS
  * FOR A SPECIFIC PURPOSE OR NONINFRINGEMENT CONCERNING THIS SOFTWARE.
  *
  */
- 
+
 #include <stdio.h>
 #include <time.h>
 #include <sys/time.h>
@@ -85,7 +85,11 @@ static void ntp_service()
 		notify_rc("restart_diskmon");
 #endif
 #ifdef RTCONFIG_UUPLUGIN
+#ifdef RTK3
+		exec_uu_k3();
+#else
 		exec_uu();
+#endif
 #endif
 	}
 }
diff --git a/release/src/router/rc/ntpd.c b/release/src/router/rc/ntpd.c
index c96be5acf2..de20eb591f 100644
--- a/release/src/router/rc/ntpd.c
+++ b/release/src/router/rc/ntpd.c
@@ -117,6 +117,13 @@ int ntpd_synced_main(int argc, char *argv[])
 #endif
 #ifdef RTCONFIG_DISK_MONITOR
 		notify_rc("restart_diskmon");
+#endif
+#ifdef RTCONFIG_UUPLUGIN
+#ifdef RTK3
+		exec_uu_k3();
+#else
+		exec_uu();
+#endif
 #endif
 
 		stop_ddns();
-- 
2.25.1

